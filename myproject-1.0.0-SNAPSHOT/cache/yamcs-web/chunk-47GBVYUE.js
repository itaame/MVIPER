import{b as Yn,d as Gn,e as Un,f as qn,g as Hn,h as qt,i as Wn,j as Qn,k as zn}from"./chunk-2UNEVVCW.js";import{a as Ht}from"./chunk-PVFYJZJB.js";import"./chunk-ERVA5QJS.js";import{a as Rn}from"./chunk-ESNLOJMT.js";import{a as In,b as $n}from"./chunk-7ZJ4C3K2.js";import{a as Bn}from"./chunk-CS6YXD3A.js";import{a as Ln}from"./chunk-UBMLYMMH.js";import{f as tt}from"./chunk-KJ5BZ5CM.js";import{a as he,c as ve,d as vi,e as jn}from"./chunk-J6RUEXVW.js";import{$ as rt,$c as Ue,$e as Ot,$f as wn,Aa as r,Ab as Ge,Ac as N,Af as T,Ba as d,Bb as Wi,Bc as L,Bf as We,Bg as Je,Ca as R,Cb as Qi,Cc as Be,Cg as Ze,D as Ai,Da as j,Db as zi,De as mn,E as _t,Eb as Ki,Ec as ce,Ee as pn,Ef as Rt,Fa as w,Fb as ht,Fc as Zi,Fe as dn,Ff as xn,Ga as _,Gb as vt,Gc as Y,Ge as un,Gf as ge,Gg as Vn,H as be,Ha as u,Hb as ye,Hc as kt,He as Tt,I as Ii,Ia as ji,Ib as Xi,Ie as Mt,Ig as et,Ja as Bi,Jc as en,Kc as G,Ke as Pt,Lc as tn,Le as fn,Lf as oe,Lg as Gt,Ma as te,Mc as xt,N as v,Na as ie,Nc as U,Ne as _n,Nf as jt,O as S,Oa as ne,Oc as nn,Pa as Li,Pc as an,Qa as Yi,Qc as on,Qe as Vt,Qf as bn,Qg as Nn,Ra as J,Rg as Ut,Sa as c,Sc as rn,Ta as ue,Tc as cn,Tf as En,Ua as D,Uc as bt,Uf as Qe,V as W,Va as hi,We as Fe,Wf as Bt,X as ot,Xa as Gi,Xc as le,Xe as Te,Ya as Ye,Yc as _e,Ye as Nt,Yf as Lt,Z as yi,Za as ae,_c as we,_e as Me,_f as ze,a as z,ag as Ke,ba as l,bb as y,bd as Et,bf as Pe,cb as k,cd as wt,cf as gn,cg as Dn,ch as On,d as Ci,da as g,db as je,ef as qe,eh as An,f as V,fa as $i,ff as At,ga as b,gb as gt,hd as ln,hf as Ve,i as Ti,id as Dt,if as He,ih as M,ja as Ri,jb as Ct,jd as Ft,k as Mi,kb as yt,kf as Cn,kg as Fn,l as Pi,lf as yn,m as Vi,ma as f,mf as hn,mg as Ae,nf as vn,ng as Xe,od as ct,oe as sn,of as Sn,oh as E,pf as Ne,pg as Tn,ph as Ie,qa as p,qb as re,qh as Si,rb as Ui,rc as St,rh as ki,s as ft,sa as se,te as q,tf as kn,uc as Ji,ue as Z,uf as Oe,ug as Mn,v as Ni,va as C,vb as qi,ve as De,vg as Pn,wa as A,wc as fe,we as H,x as Oi,xa as I,xb as Hi,xe as ee,ya as $,yc as B,ye as K,yf as It,yg as Yt,za as o,ze as X,zf as $t}from"./chunk-MTJQDUEX.js";var Wt=class n{constructor(t,e){this.dialogRef=t;this.form=e.group({executionTime:["",[B.required]],tags:[[],[]]})}schedule(){this.dialogRef.close(this.form.value)}static{this.\u0275fac=function(e){return new(e||n)(g(q),g(le))}}static{this.\u0275cmp=b({type:n,selectors:[["app-schedule-script-dialog"]],decls:26,vars:4,consts:[["mat-dialog-title",""],[1,"hint"],[1,"ya-form",3,"formGroup"],[1,"label"],["formControlName","executionTime",3,"showMillis","showNow"],[1,"half-break"],["dialogTitle","Timeline Tags"],["formControlName","tags"],["align","end"],[2,"flex","1 1 auto"],["mat-dialog-close",""],["appearance","primary",3,"click","disabled"]],template:function(e,i){e&1&&(o(0,"h2",0),c(1,"Run later"),r(),o(2,"mat-dialog-content")(3,"div",1)(4,"p"),c(5,"This script will be submitted to the Yamcs Timeline, for execution at a later time."),r()(),o(6,"form",2)(7,"div",3),c(8," Execution time "),d(9,"br")(10,"ya-date-time-input",4),r(),d(11,"hr",5),o(12,"div",3),c(13," Timeline tags "),o(14,"span",1),c(15,"(optional)"),r(),o(16,"ya-help",6),c(17," Tags allow to categorise items per band. Bands only show items for which one of the tags is matching. "),r(),d(18,"br")(19,"ya-tag-select",7),r()()(),o(20,"mat-dialog-actions",8),d(21,"div",9),o(22,"ya-button",10),c(23,"CANCEL"),r(),o(24,"ya-button",11),_("click",function(){return i.schedule()}),c(25,"SCHEDULE"),r()()),e&2&&(l(6),p("formGroup",i.form),l(4),p("showMillis",!0)("showNow",!0),l(14),p("disabled",!i.form.valid))},dependencies:[E,Y,N,L,G,U,H,ee,X,K,T,jt,Ke,Yt],encapsulation:2,changeDetection:0})}};function na(n,t){if(n&1){let e=w();c(0," \xA0 "),d(1,"ya-icon-action",9),o(2,"mat-menu",10,0)(4,"button",11),_("click",function(){v(e);let a=u();return S(a.runScript())}),c(5,"Run now"),r(),o(6,"button",11),_("click",function(){v(e);let a=u();return S(a.openScheduleScriptDialog())}),c(7,"Run later..."),r()()}if(n&2){let e=J(3),i=u();l(),p("matMenuTriggerFor",i.form.valid?e:null)("padding",!1)("disabled",!i.form.valid),l(),p("overlapTrigger",!1)}}var Qt=class n{constructor(t,e,i,a,s,m,h){this.yamcs=i;this.messageService=a;this.authService=s;this.router=m;this.dialog=h;this.scriptOptions$=new V([]);t.setTitle("Run a script"),this.form=e.group({script:["",[B.required]],args:[""]}),i.yamcsClient.getActivityScripts(this.yamcs.instance).then(x=>{for(let Q of x.scripts||[])this.scriptOptions$.next([...this.scriptOptions$.value,{id:Q,label:Q}])}).catch(x=>a.showError(x))}runScript(){let t=this.createActivityDefinition();this.yamcs.yamcsClient.startActivity(this.yamcs.instance,t).then(e=>{this.authService.getUser().hasSystemPrivilege("ReadActivities")?this.router.navigateByUrl(`/activities/${e.id}?c=${this.yamcs.context}`):this.dialog.open(wn,{width:"500px",data:{icon:"done",closeText:"OK",content:`
                <p>The procedure has started executing.</p>
                <p>
                  Note that you do not have sufficient privileges
                  to follow up on submitted procedures.
                </p>
              `}}).afterClosed().subscribe(()=>this.form.reset())}).catch(e=>this.messageService.showError(e))}showSchedule(){let t=this.yamcs.connectionInfo$.value?.instance?.capabilities||[];return t.indexOf("timeline")!==-1&&t.indexOf("activities")!==-1&&this.authService.getUser().hasSystemPrivilege("ControlTimeline")}openScheduleScriptDialog(){this.dialog.open(Wt,{width:"600px"}).afterClosed().subscribe(t=>{let e=this.form.value;if(t){let i={type:"ACTIVITY",duration:"0s",name:e.script,start:t.executionTime,tags:t.tags,activityDefinition:this.createActivityDefinition()};this.yamcs.yamcsClient.createTimelineItem(this.yamcs.instance,i).then(()=>{this.messageService.showInfo("Script scheduled"),this.router.navigateByUrl(`/activities?c=${this.yamcs.context}`)}).catch(a=>this.messageService.showError(a))}})}createActivityDefinition(){let t=this.form.value,e={type:"SCRIPT",args:{processor:this.yamcs.processor||null,script:t.script}};return t.args&&(e.args.args=t.args),e}static{this.\u0275fac=function(e){return new(e||n)(g(Ge),g(le),g(M),g(Ne),g(Ie),g(vt),g(De))}}static{this.\u0275cmp=b({type:n,selectors:[["ng-component"]],decls:23,vars:6,consts:[["sendMenu","matMenu"],[1,"form-content","ya-form"],["novalidate","","autocomplete","off",3,"formGroup"],[1,"label"],[1,"hint"],["formControlName","script",3,"options"],["type","text","formControlName","args"],[2,"flex","1 1 auto"],["appearance","primary",3,"click","disabled"],["icon","arrow_drop_down",2,"line-height","12px",3,"matMenuTriggerFor","padding","disabled"],[1,"ya-menu",3,"overlapTrigger"],["mat-menu-item","",3,"click"]],template:function(e,i){e&1&&(o(0,"app-instance-page")(1,"app-instance-toolbar"),c(2,"Run a script"),r(),o(3,"div",1)(4,"form",2)(5,"div",3),c(6," Script "),o(7,"span",4),c(8,"(required)"),r(),d(9,"br")(10,"ya-select",5),y(11,"async"),r(),d(12,"br"),o(13,"div",3),c(14," Script arguments "),d(15,"input",6),r()(),o(16,"p"),c(17,"\xA0"),r(),o(18,"mat-toolbar"),d(19,"span",7),o(20,"ya-button",8),_("click",function(){return i.runScript()}),c(21,"Run"),r(),f(22,na,8,4),r()()()),e&2&&(l(4),p("formGroup",i.form),l(6),p("options",k(11,4,i.scriptOptions$)),l(10),p("disabled",!i.form.valid),l(2),C(i.showSchedule()?22:-1))},dependencies:[ve,he,E,re,Y,fe,N,L,G,U,Et,Ue,wt,Dt,T,We,Qe],encapsulation:2,changeDetection:0})}};var zt=class n{constructor(t,e){this.dialogRef=t;this.data=e}confirmDiscard(){let{stackFileService:t}=this.data;t.dirty$.next(!1),this.dialogRef.close(!0)}static{this.\u0275fac=function(e){return new(e||n)(g(q),g(Z))}}static{this.\u0275cmp=b({type:n,selectors:[["app-stack-file-page-dirty-dialog"]],decls:10,vars:0,consts:[["align","end"],["mat-dialog-close",""],["appearance","primary",3,"click"]],template:function(e,i){e&1&&(o(0,"mat-dialog-content")(1,"h3"),c(2,"Close without saving?"),r(),o(3,"p"),c(4,"You have unsaved changes, close without saving?"),r()(),o(5,"mat-dialog-actions",0)(6,"ya-button",1),c(7,"CANCEL"),r(),o(8,"ya-button",2),_("click",function(){return i.confirmDiscard()}),c(9,"OK"),r()())},dependencies:[E,H,X,K,T],encapsulation:2})}};var it=class{constructor(t){this.executing=!1;this.model=t}get comment(){return this.model.comment}clearOutputs(){this.executionNumber=void 0,this.err=void 0}hasOutputs(){return!!this.err}},pe=class n extends it{constructor(e){super(e);this.type="command"}get name(){return this.model.name}get namespace(){return this.model.namespace}get args(){return this.model.args}get extra(){return this.model.extra}get stream(){return this.model.stream}get advancement(){return this.model.advancement}clearOutputs(){super.clearOutputs(),this.id=void 0,this.record=void 0}hasOutputs(){return super.hasOutputs()||!!this.record}copy(){let e=new n({type:"command",name:this.name,namespace:this.namespace,args:z({},this.args),comment:this.comment,stream:this.stream});return e.command=this.command,this.extra&&(e.model.extra=z({},this.extra)),this.advancement&&(e.model.advancement=z({},this.advancement)),e}toString(){let e=this.name;if(this.args){e+=" [";let i=!0;for(let a in this.args)i?i=!1:e+=", ",e+=`${a}=${this.args[a]}`;e+="]"}return e}},ke=class n extends it{constructor(e){super(e);this.type="verify"}get condition(){return this.model.condition}get delay(){return this.model.delay}get timeout(){return this.model.timeout}clearOutputs(){super.clearOutputs(),this.pvals=void 0}hasOutputs(){return super.hasOutputs()||!!this.pvals}copy(){return new n({type:"verify",condition:this.condition.map(e=>z({},e)),comment:this.comment})}toString(){let e="",i=!0;for(let a of this.condition||[]){switch(i?i=!1:e+=" AND ",e+=a.parameter,a.operator){case"eq":e+=" = ";break;case"neq":e+=" != ";break;case"lt":e+=" < ";break;case"lte":e+=" <= ";break;case"gt":e+=" > ";break;case"gte":e+=" >= ";break}e+=a.value}return e}test(e){let i=[];for(let s of this.condition){let m=e;i.push({parameter:s.parameter,pval:m[s.parameter]||null,status:ot(null)})}this.pvals=i;let a=!0;for(let s=0;s<this.condition.length;s++){let m=i[s];if(m===null||!m.pval?.engValue){a=!1;continue}else if(m.pval?.engValue){let h=Un(m.pval.engValue),x=String(this.condition[s].value);switch(this.condition[s].operator){case"eq":h===x?m.status.set("ok"):(a=!1,m.status.set("pending"));break;case"neq":h!==x?m.status.set("ok"):(a=!1,m.status.set("pending"));break;case"lt":isNaN(h)||isNaN(x)?(a=!1,m.status.set("pending")):Number(h)<Number(x)?m.status.set("ok"):(a=!1,m.status.set("pending"));break;case"lte":isNaN(h)||isNaN(x)?(a=!1,m.status.set("pending")):Number(h)<=Number(x)?m.status.set("ok"):(a=!1,m.status.set("pending"));break;case"gt":isNaN(h)||isNaN(x)?(a=!1,m.status.set("pending")):Number(h)>Number(x)?m.status.set("ok"):(a=!1,m.status.set("pending"));break;case"gte":isNaN(h)||isNaN(x)?(a=!1,m.status.set("pending")):Number(h)>=Number(x)?m.status.set("ok"):(a=!1,m.status.set("pending"));break}}else{a=!1,m.status.set("pending");continue}}return a}},Ee=class n extends it{constructor(e){super(e);this.type="check"}get parameters(){return this.model.parameters}clearOutputs(){super.clearOutputs(),this.pvals=void 0}hasOutputs(){return super.hasOutputs()||!!this.pvals}copy(){return new n({type:"check",parameters:this.parameters.map(e=>z({},e)),comment:this.comment})}},xe=class n extends it{constructor(e){super(e);this.type="text";this.renderedText=ot("")}get text(){return this.model.text}copy(){return new n({type:"text",text:this.text})}};function Jn(n,t){let i=new DOMParser().parseFromString(n,"text/xml");return aa(i.documentElement,t)}function aa(n,t){let e=[];for(let i=0;i<n.childNodes.length;i++){let a=n.childNodes[i];if(a.nodeType!==3&&a.nodeName==="command"){let s=oa(a,t);e.push(s)}}return e}function oa(n,t){let e={},i={};for(let s=0;s<n.childNodes.length;s++){let m=n.childNodes[s];if(m.nodeName==="commandArgument"){let h=nt(m,"argumentName");e[h]=nt(m,"argumentValue"),e[h]==="true"?e[h]=!0:e[h]==="false"&&(e[h]=!1)}else if(m.nodeName==="extraOptions")for(let h=0;h<m.childNodes.length;h++){let x=m.childNodes[h];if(x.nodeName==="extraOption"){let Q=nt(x,"id"),Ce=nt(x,"value"),at=ra(Q,Ce,t);at&&(i[Q]=at)}}}let a={type:"command",name:nt(n,"qualifiedName"),args:e,extra:i};return n.hasAttribute("comment")&&(a.comment=nt(n,"comment")),a}function nt(n,t){let e=n.attributes.getNamedItem(t);if(e===null)throw new Error(`No attribute named ${t}`);return e.textContent||""}function ra(n,t,e){for(let i of e)if(i.id===n)switch(i.type){case"BOOLEAN":return{type:"BOOLEAN",booleanValue:t==="true"};case"NUMBER":return{type:"SINT32",sint32Value:Number(t)};default:return{type:"STRING",stringValue:t}}return null}function ea(n,t){let e=[],i=JSON.parse(n);if(i.steps)for(let s of i.steps)s.type==="check"?e.push(s):s.type==="command"?e.push(Zn(s,t)):s.type==="text"?e.push(ca(s)):s.type==="verify"?e.push(s):console.warn(`Unexpected entry of type '${s.type}'`);else if(i.commands)for(let s of i.commands)e.push(Zn(s,t));let a={acknowledgment:i.advancement?.acknowledgment||"Acknowledge_Queued",wait:i.advancement?.wait!=null?i.advancement?.wait:0};return[e,a]}function Zn(n,t){return z(z(z(z(z({type:"command",name:n.name,namespace:n.namespace},n.comment&&{comment:n.comment}),n.stream&&{stream:n.stream}),n.arguments&&{args:la(n.arguments)}),n.extraOptions&&{extra:sa(n.extraOptions,t)}),n.advancement&&{advancement:n.advancement})}function ca(n){return{type:"text",text:n.text}}function la(n){let t={};for(let e of n)t[e.name]=e.value;return t}function sa(n,t){let e={};for(let i of n){let a=new String(i.value).toString(),s=ma(i.id,a,t);s&&(e[i.id]=s)}return e}function ma(n,t,e){for(let i of e)if(i.id===n)switch(i.type){case"BOOLEAN":return{type:"BOOLEAN",booleanValue:t==="true"};case"NUMBER":return{type:"SINT32",sint32Value:Number(t)};default:return{type:"STRING",stringValue:t}}return null}var de=class n{constructor(t,e,i){this.configService=t;this.yamcs=e;this.messageService=i;this.entries=[];this.advancement={acknowledgment:"Acknowledge_Queued",wait:0};this.dirty$=new V(!1);this.entries$=new V([]);this.hasState$=this.entries$.pipe(Vi(t=>{for(let e of t)if(e.hasOutputs()||e.executionNumber!==void 0)return!0;return!1}));this.logs$=new V([]);this.bucket=t.getStackBucket(),this.storageClient=e.createStorageClient()}markDirty(){this.dirty$.next(!0)}addLogEntry(t,e){this.logs$.next([...this.logs$.value,{executionNumber:t,text:e,time:this.yamcs.getMissionTime().toISOString()}])}async canActivate(t,e){this.entries=[],this.objectName=t.params.objectName;let i=oe.getExtension(oe.getFilename(this.objectName))?.toLowerCase();try{let a=await this.storageClient.getObject(this.bucket,this.objectName);if(a.ok){let s=await a.text();if(i==="xml"||i==="ycs")await this.processStack(s,i);else return!1}}catch(a){return this.messageService.showError(a),!1}return!0}async processStack(t,e){switch(this.entries=[],e){case"ycs":let m;[m,this.advancement]=ea(t,this.configService.getCommandOptions());for(let x of m)x.type==="check"?this.entries.push(new Ee(x)):x.type==="command"?this.entries.push(new pe(x)):x.type==="text"?this.entries.push(new xe(x)):x.type==="verify"?this.entries.push(new ke(x)):console.error("Unexpected step",x);break;case"xml":let h=Jn(t,this.configService.getCommandOptions());for(let x of h)this.entries.push(new pe(x));break}let i=this.entries.filter(m=>m instanceof pe),a=[],s=this.yamcs.instance;for(let m of i){let h=m.namespace??null,x=m.name;a.push(this.yamcs.yamcsClient.getCommandForNamespace(s,h,x).then(Q=>{m.command=Q}))}for(let m of a)try{await m}catch{}for(let m of i)if(m.command)for(let h in m.args){let x=this.getArgument(h,m.command);if(x?.type.engType==="enumeration"){let Q=!1;for(let Ce of x.type.enumValue||[])if(Ce.label===m.args[h]){Q=!0;break}if(!Q){for(let Ce of x.type.enumValue||[])if(String(Ce.value)===String(m.args[h])){m.args[h]=Ce.label,Q=!0;break}}}}if(e==="xml"){for(let m of i)if(m.command)for(let h in m.args)this.isComplex(h,m.command)&&(m.args[h]=JSON.parse(m.args[h]))}}getArgument(t,e){for(let i of e.argument||[])if(i.name===t)return i;return e.baseCommand?this.getArgument(t,e.baseCommand):null}isComplex(t,e){for(let i of e.argument||[])if(i.name===t)return i.type.engType==="aggregate"||i.type.engType.endsWith("[]");return e.baseCommand?this.isComplex(t,e.baseCommand):!1}updateEntries(t){this.renumberHeadings(t),this.entries$.next(t)}renumberHeadings(t){let e=[0,0,0,0,0,0];for(let i of t)if(i instanceof xe){let a=[];for(let s of i.text.split(`
`))if(s.startsWith("# ")){e[0]++,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0;let m=`# ${e[0]}.&nbsp;&nbsp;`+s.slice(2);a.push(m)}else if(s.startsWith("## ")){e[1]++,e[2]=0,e[3]=0,e[4]=0,e[5]=0;let m=`## ${e[0]}.${e[1]}.&nbsp;&nbsp;`+s.slice(3);a.push(m)}else if(s.startsWith("### ")){e[2]++,e[3]=0,e[4]=0,e[5]=0;let m=`### ${e[0]}.${e[1]}.${e[2]}.&nbsp;&nbsp;`+s.slice(4);a.push(m)}else if(s.startsWith("#### ")){e[3]++,e[4]=0,e[5]=0;let m=`#### ${e[0]}.${e[1]}.${e[2]}.${e[3]}.&nbsp;&nbsp;`+s.slice(5);a.push(m)}else if(s.startsWith("##### ")){e[4]++,e[5]=0;let m=`##### ${e[0]}.${e[1]}.${e[2]}.${e[3]}.${e[4]}.&nbsp;&nbsp;`+s.slice(6);a.push(m)}else if(s.startsWith("###### ")){e[5]++;let m=`###### ${e[0]}.${e[1]}.${e[2]}.${e[3]}.${e[4]}.${e[5]}.&nbsp;&nbsp;`+s.slice(7);a.push(m)}else a.push(s);i.renderedText.set(a.join(`
`))}}saveStack(){let t=oe.getExtension(oe.getFilename(this.objectName))?.toLowerCase(),e=this.entries$.value.map(m=>m.model),i;switch(t){case"ycs":i=new Oe(e,{advancement:this.advancement}).toJSON();break;case"xml":i=new Oe(e,{advancement:this.advancement}).toXML();break;default:console.error("Unexpected format");return}let a=t==="xml"?"application/xml":"application/json",s=new Blob([i],{type:a});return this.storageClient.uploadObject(this.bucket,this.objectName,s).then(()=>{this.dirty$.next(!1)})}static{this.\u0275fac=function(e){return new(e||n)(be(ge),be(M),be(Ne))}}static{this.\u0275prov=_t({token:n,factory:n.\u0275fac})}};var ta=n=>Ii(st).canDeactivate(n),st=class n{constructor(t,e,i,a){this.dialog=t;this.authService=e;this.stackFileService=a;this.dialogOpen$=new V(!1);this.bucket=i.getStackBucket()}canDeactivate(t){return this.dialogOpen$.value?new Ci(e=>{this.dialogRef.afterClosed().subscribe({next:i=>{e.next(i===!0),e.complete()},error:()=>{e.next(!1),e.complete()}})}):this.stackFileService.dirty$.value&&this.mayManageStacks()?new Ci(e=>{this.dialogOpen$.next(!0),this.dialogRef=this.dialog.open(zt,{width:"400px",data:{stackFileService:this.stackFileService}}),this.dialogRef.afterClosed().subscribe({next:i=>{this.dialogOpen$.next(!1),e.next(i===!0),e.complete()},error:()=>{this.dialogOpen$.next(!1),e.next(!1),e.complete()}})}):Ti(!0)}mayManageStacks(){let t=this.authService.getUser();return t.hasObjectPrivilege("ManageBucket",this.bucket)||t.hasSystemPrivilege("ManageAnyBucket")}static{this.\u0275fac=function(e){return new(e||n)(be(De),be(Ie),be(ge),be(de))}}static{this.\u0275prov=_t({token:n,factory:n.\u0275fac})}};var da=["*"],ua=()=>({exact:!0}),bi=n=>({c:n}),$e=class n{constructor(t){this.yamcs=t;this.objectName=W.required()}static{this.\u0275fac=function(e){return new(e||n)(g(M))}}static{this.\u0275cmp=b({type:n,selectors:[["app-stack-file-page-tabs"]],inputs:{objectName:[1,"objectName"]},ngContentSelectors:da,decls:16,vars:19,consts:[["rla","routerLinkActive"],["rlb","routerLinkActive"],["rlc","routerLinkActive"],["tabPanel",""],["mat-tab-nav-bar","",1,"secondary",3,"mat-stretch-tabs","tabPanel"],["mat-tab-link","","routerLinkActive","",3,"routerLink","routerLinkActiveOptions","active","queryParams"],["mat-tab-link","","routerLinkActive","",3,"routerLink","active","queryParams"],[2,"flex","1 1 auto"],[2,"align-self","center"]],template:function(e,i){if(e&1&&(ji(),o(0,"nav",4)(1,"a",5,0),c(3," Steps "),r(),o(4,"a",6,1),c(6," Log "),r(),o(7,"a",6,2),c(9," Settings "),r(),d(10,"span",7),o(11,"div",8),Bi(12),r()(),o(13,"mat-tab-nav-panel",null,3),d(15,"router-outlet"),r()),e&2){let a=J(2),s=J(5),m=J(8),h=J(14);p("mat-stretch-tabs",!1)("tabPanel",h),l(),p("routerLink","/procedures/stacks/files/"+i.objectName())("routerLinkActiveOptions",Ye(12,ua))("active",a.isActive)("queryParams",ae(13,bi,i.yamcs.context)),l(3),p("routerLink","/procedures/stacks/files/"+i.objectName()+"/-/log")("active",s.isActive)("queryParams",ae(15,bi,i.yamcs.context)),l(3),p("routerLink","/procedures/stacks/files/"+i.objectName()+"/-/settings")("active",m.isActive)("queryParams",ae(17,bi,i.yamcs.context))}},dependencies:[E,ht,ye,Xi,hn,Sn,vn],styles:[".mat-mdc-tab-link[_ngcontent-%COMP%]{height:36px;min-width:0;font-size:13px}"],changeDetection:0})}};var fa=n=>({c:n});function _a(n,t){if(n&1&&(o(0,"tr")(1,"td",6),c(2),r(),o(3,"td",7),c(4),y(5,"datetime"),r(),o(6,"td",8),c(7),r()()),n&2){let e=t.$implicit;l(2),D("[",e.executionNumber,"]"),l(2),D(" [",je(5,3,e.time,!1),"] "),l(3),ue(e.text)}}var Xt=class n{constructor(t,e){this.yamcs=t;this.stackFileService=e;this.objectName=W.required();this.folderLink=Ct(()=>{let t=this.objectName(),e=t.lastIndexOf("/");return e===-1?"/procedures/stacks/browse/":"/procedures/stacks/browse/"+t.substring(0,e)})}static{this.\u0275fac=function(e){return new(e||n)(g(M),g(de))}}static{this.\u0275cmp=b({type:n,selectors:[["app-stack-file-log"]],inputs:{objectName:[1,"objectName"]},decls:15,vars:13,consts:[["icon","arrow_back",3,"routerLink","queryParams"],["matTooltip","Save stack","icon","save",3,"clicked","disabled"],[1,"main-pane"],[3,"objectName"],[1,"tab-content"],[1,"mono",2,"width","100%"],["width","1",2,"text-align","right"],["width","1",1,"time",2,"white-space","nowrap"],[1,"message"]],template:function(e,i){e&1&&(o(0,"app-instance-page")(1,"app-instance-toolbar"),d(2,"ya-page-icon-button",0),c(3),y(4,"basename"),o(5,"ya-page-button",1),y(6,"async"),_("clicked",function(){return i.stackFileService.saveStack()}),c(7," Save "),r()(),o(8,"div",2),d(9,"app-stack-file-page-tabs",3),o(10,"div",4)(11,"table",5),I(12,_a,8,6,"tr",null,A),y(14,"async"),r()()()()),e&2&&(l(2),p("routerLink",i.folderLink())("queryParams",ae(11,fa,i.yamcs.context)),l(),D(" ",k(4,5,i.objectName())," \xA0\xA0\xA0 "),l(2),p("disabled",!k(6,7,i.stackFileService.dirty$)),l(4),p("objectName",i.objectName()),l(3),$(k(14,9,i.stackFileService.logs$)))},dependencies:[he,ve,$e,E,re,ye,we,Ae,Xe,et,Gt],styles:[".main-pane[_ngcontent-%COMP%]{position:absolute;inset:0;padding:24px}.tab-content[_ngcontent-%COMP%]{position:absolute;inset:60px 0 0;overflow:auto;padding:24px}table[_ngcontent-%COMP%]{line-height:12px}table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{font-size:12px;color:#000000a7;vertical-align:top}table[_ngcontent-%COMP%]   td.time[_ngcontent-%COMP%]{opacity:.8}table[_ngcontent-%COMP%]   td.message[_ngcontent-%COMP%]{white-space:pre-wrap}"],changeDetection:0})}};var ga=n=>({c:n});function Ca(n,t){n&1&&d(0,"input",11)}var Jt=class n{constructor(t,e){this.yamcs=t;this.stackFileService=e;this.objectName=W.required();this.folderLink=Ct(()=>{let t=this.objectName(),e=t.lastIndexOf("/");return e===-1?"/procedures/stacks/browse/":"/procedures/stacks/browse/"+t.substring(0,e)});this.ackOptions=[{id:"Acknowledge_Queued",label:"Queued"},{id:"Acknowledge_Released",label:"Released"},{id:"Acknowledge_Sent",label:"Sent"},{id:"CommandComplete",label:"Completed"}];this.stackOptionsForm=new Be({advancementAckDropDown:new ce("",[]),advancementAckCustom:new ce("",[]),advancementWait:new ce("",[])}),this.extraAcknowledgments=t.getProcessor()?.acknowledgments??[];let i=!0;for(let h of this.extraAcknowledgments)this.ackOptions.push({id:h.name,label:h.name.replace("Acknowledge_",""),group:i}),i=!1;this.ackOptions.push({id:"custom",label:"Custom",group:!0});let{advancement:a}=this.stackFileService,s=this.ackOptions.find(h=>h.id===a.acknowledgment),m=s?s.id:"custom";this.stackOptionsForm.setValue({advancementAckDropDown:m,advancementAckCustom:m==="custom"?a.acknowledgment:"",advancementWait:a.wait}),this.stackOptionsForm.valueChanges.subscribe(h=>{this.stackFileService.advancement={acknowledgment:h.advancementAckDropDown!=="custom"?h.advancementAckDropDown:h.advancementAckCustom,wait:h.advancementWait??0},h.advancementAckDropDown!=="custom"&&this.stackOptionsForm.patchValue({advancementAckCustom:void 0},{emitEvent:!1}),this.stackFileService.markDirty()})}static{this.\u0275fac=function(e){return new(e||n)(g(M),g(de))}}static{this.\u0275cmp=b({type:n,selectors:[["app-stack-file-settings"]],inputs:{objectName:[1,"objectName"]},decls:32,vars:15,consts:[["ackSelect",""],["icon","arrow_back",3,"routerLink","queryParams"],["matTooltip","Save stack","icon","save",3,"clicked","disabled"],[1,"main-pane"],[3,"objectName"],[1,"tab-content"],[1,"ya-form",3,"formGroup"],[1,"label"],[3,"extra"],[2,"display","flex","align-items","flex-start"],["icon","check_circle_outline","formControlName","advancementAckDropDown",3,"options"],["type","text","formControlName","advancementAckCustom",2,"width","200px","margin-left","-1px"],["dialogTitle","Wait time"],["type","number","formControlName","advancementWait","placeholder","0","step","1000","min","0",2,"width","120px"]],template:function(e,i){if(e&1){let a=w();o(0,"app-instance-page")(1,"app-instance-toolbar"),d(2,"ya-page-icon-button",1),c(3),y(4,"basename"),o(5,"ya-page-button",2),y(6,"async"),_("clicked",function(){return v(a),S(i.stackFileService.saveStack())}),c(7," Save "),r()(),o(8,"div",3),d(9,"app-stack-file-page-tabs",4),o(10,"div",5)(11,"form",6)(12,"h3"),c(13,"Commanding"),r(),o(14,"div",7),c(15," Advance when "),d(16,"app-advance-ack-help",8)(17,"br"),o(18,"div",9),d(19,"ya-select",10,0),f(21,Ca,1,0,"input",11),r()(),d(22,"br"),o(23,"div",7),c(24," Wait (ms) "),o(25,"ya-help",12)(26,"p"),c(27,"Wait time before advancing to the next command in the stack."),r(),o(28,"p"),c(29,"This triggers after successful acknowledgment."),r()(),d(30,"br")(31,"input",13),r()()()()()}if(e&2){let a;l(2),p("routerLink",i.folderLink())("queryParams",ae(13,ga,i.yamcs.context)),l(),D(" ",k(4,9,i.objectName())," \xA0\xA0\xA0 "),l(2),p("disabled",!k(6,11,i.stackFileService.dirty$)),l(4),p("objectName",i.objectName()),l(2),p("formGroup",i.stackOptionsForm),l(5),p("extra",i.extraAcknowledgments),l(3),p("options",i.ackOptions),l(2),C(((a=i.stackOptionsForm.get("advancementAckDropDown"))==null?null:a.value)==="custom"?21:-1)}},dependencies:[qn,he,ve,$e,E,re,Y,fe,kt,N,L,rn,G,U,ye,we,Ke,Ae,Xe,Qe,et],styles:[".main-pane[_ngcontent-%COMP%]{position:absolute;inset:0;padding:24px}.tab-content[_ngcontent-%COMP%]{position:absolute;inset:60px 0 0;overflow:auto;padding:24px}"],changeDetection:0})}};function ya(n,t){if(n&1){let e=w();o(0,"tr")(1,"td",11),d(2,"app-parameter-input",12),r(),o(3,"td",13)(4,"ya-icon-action",14),_("click",function(){let a=v(e).$index,s=u();return S(s.moveParameterControlDown(a))}),r(),o(5,"ya-icon-action",15),_("click",function(){let a=v(e).$index,s=u();return S(s.moveParameterControlUp(a))}),r(),o(6,"ya-text-action",16),_("click",function(){let a=v(e).$index,s=u();return S(s.removeParameterControl(a))}),c(7," DELETE "),r()()()}if(n&2){let e=t.$index,i=t.$count;l(2),p("formControlName",e),l(2),p("disabled",e===i-1),l(),p("disabled",e===0)}}var mt=class n{constructor(t,e){this.dialogRef=t;this.data=e;if(this.form=new Be({parameters:new bt([]),comment:new ce("")}),e.entry){let i=(e.entry.parameters||[]).map(a=>a.parameter);for(let a of i)this.addParameterControl();this.form.setValue({parameters:i||[],comment:e.entry.comment||""})}this.parameterFormArray.length||this.addParameterControl()}get parameterFormArray(){return this.form.controls.parameters}get parameterControls(){return this.parameterFormArray.controls}addParameterControl(){this.parameterFormArray.push(new ce(""))}removeParameterControl(t){this.parameterFormArray.removeAt(t)}moveParameterControlDown(t){let e=this.parameterFormArray.controls[t];this.parameterFormArray.removeAt(t),this.parameterFormArray.insert(t+1,e)}moveParameterControlUp(t){let e=this.parameterFormArray.controls[t];this.parameterFormArray.removeAt(t),this.parameterFormArray.insert(t-1,e)}save(){let{value:t}=this.form,e={comment:t.comment,parameters:t.parameters.map(i=>({parameter:i}))};this.dialogRef.close(e)}static{this.\u0275fac=function(e){return new(e||n)(g(q),g(Z))}}static{this.\u0275cmp=b({type:n,selectors:[["app-edit-check-entry-dialog"]],decls:24,vars:2,consts:[["mat-dialog-title",""],[1,"ya-form",3,"formGroup"],[1,"label"],["formArrayName","parameters",1,"parameter-table",2,"width","100%"],["colspan","1"],["icon","add_circle_outline",3,"click"],["formControlName","comment"],["align","end"],[2,"flex","1 1 auto"],["mat-dialog-close",""],["appearance","primary",3,"click"],[2,"width","100%"],[3,"formControlName"],[2,"white-space","nowrap"],["icon","keyboard_arrow_down",3,"click","disabled"],["icon","keyboard_arrow_up",3,"click","disabled"],["icon","delete",3,"click"]],template:function(e,i){e&1&&(o(0,"h2",0),c(1,"Step: List parameters"),r(),o(2,"mat-dialog-content")(3,"form",1)(4,"div",2),c(5," Parameters "),d(6,"br"),o(7,"table",3),I(8,ya,8,3,"tr",null,A),o(10,"tr")(11,"td",4)(12,"ya-button",5),_("click",function(){return i.addParameterControl()}),c(13," \xA0Add "),r()()()()(),d(14,"br"),o(15,"div",2),c(16," Comment "),d(17,"app-markdown-input",6),r()()(),o(18,"mat-dialog-actions",7),d(19,"div",8),o(20,"ya-button",9),c(21,"CANCEL"),r(),o(22,"ya-button",10),_("click",function(){return i.save()}),c(23),r()()),e&2&&(l(3),p("formGroup",i.form),l(5),$(i.parameterControls),l(15),D(" ",i.data.edit?"UPDATE":"ADD TO STACK"," "))},dependencies:[qt,Ht,E,Y,N,L,G,U,xt,H,ee,X,K,T,We,ze],styles:[".parameter-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:first-child{margin-left:0;padding-left:0}[_nghost-%COMP%]     .parameter-table input{margin:0!important}"],changeDetection:0})}};var va=["top"],Sa=["searchFilter"];function ka(n,t){if(n&1){let e=w();o(0,"ya-breadcrumb",10),_("click",function(){let a=v(e).$implicit,s=u(3);return S(s.changeSystem(a.system))}),r()}if(n&2){let e=t.$implicit;p("action",!0)("label",e.name)}}function xa(n,t){if(n&1){let e=w();o(0,"div",3)(1,"ya-breadcrumb-trail")(2,"ya-breadcrumb",8),_("click",function(){v(e);let a=u(2);return S(a.changeSystem(""))}),r(),I(3,ka,1,2,"ya-breadcrumb",9,A),r()()}if(n&2){let e=u();l(2),p("action",!0),l(),$(e)}}function ba(n,t){n&1&&f(0,xa,5,1,"div",3),n&2&&C(t.length?0:-1)}function Ea(n,t){n&1&&(o(0,"th",24),c(1,"Name"),r())}function wa(n,t){if(n&1){let e=w();o(0,"mat-icon",26),c(1,"folder"),r(),o(2,"a",27),_("click",function(){v(e);let a=u().$implicit,s=u(2);return S(s.selectRow(a))}),c(3),y(4,"filename"),r()}if(n&2){let e=u().$implicit;l(3),D("",k(4,1,e.name),"/")}}function Da(n,t){if(n&1&&d(0,"ya-highlight",28),n&2){let e=u(2).$implicit,i=u(2);p("text",e.command.qualifiedName)("term",i.filterControl.value)}}function Fa(n,t){if(n&1&&(d(0,"ya-highlight",28),y(1,"slice")),n&2){let e=u(2).$implicit,i=u(2);p("text",je(1,2,e.command.qualifiedName,i.system.length+1))("term",i.filterControl.value)}}function Ta(n,t){if(n&1){let e=w();o(0,"mat-icon",26),c(1,"rss_feed"),r(),o(2,"a",27),_("click",function(){v(e);let a=u().$implicit,s=u(2);return S(s.selectRow(a))}),f(3,Da,1,2,"ya-highlight",28)(4,Fa,2,5,"ya-highlight",28),r()}if(n&2){let e=u(3);l(3),C(e.system?-1:3),l(),C(e.system?4:-1)}}function Ma(n,t){if(n&1&&(o(0,"td",25),f(1,wa,5,3)(2,Ta,5,2),r()),n&2){let e=t.$implicit;l(),C(e.system?1:-1),l(),C(e.command?2:-1)}}function Pa(n,t){n&1&&(o(0,"th",24),c(1,"Description"),r())}function Va(n,t){if(n&1&&c(0),n&2){let e=u().$implicit;D(" ",e.system.shortDescription||"-"," ")}}function Na(n,t){if(n&1&&d(0,"ya-highlight",28),n&2){let e=u(4);p("text",t)("term",e.filterControl.value)}}function Oa(n,t){n&1&&c(0," - ")}function Aa(n,t){if(n&1&&f(0,Na,1,2,"ya-highlight",28)(1,Oa,1,0),n&2){let e,i=u().$implicit;C((e=i.command.shortDescription)?0:1,e)}}function Ia(n,t){if(n&1&&(o(0,"td",29),f(1,Va,1,1)(2,Aa,2,1),r()),n&2){let e=t.$implicit;l(),C(e.system?1:-1),l(),C(e.command?2:-1)}}function $a(n,t){n&1&&(o(0,"th",24),c(1,"Significance"),r())}function Ra(n,t){n&1&&d(0,"app-significance-level",31),n&2&&p("level",t.consequenceLevel)}function ja(n,t){n&1&&c(0," - ")}function Ba(n,t){if(n&1&&(o(0,"td",30),f(1,Ra,1,1,"app-significance-level",31)(2,ja,1,0),r()),n&2){let e,i=t.$implicit;l(),C((e=i.command==null?null:i.command.effectiveSignificance)?1:2,e)}}function La(n,t){if(n&1&&(o(0,"th",24),c(1),r()),n&2){let e=u().$implicit;l(),D(" ",e.label," ")}}function Ya(n,t){if(n&1&&d(0,"ya-highlight",28),n&2){let e=u(4);p("text",t)("term",e.filterControl.value)}}function Ga(n,t){n&1&&c(0," - ")}function Ua(n,t){if(n&1&&(o(0,"td",30),f(1,Ya,1,2,"ya-highlight",28),y(2,"alias"),f(3,Ga,1,0),r()),n&2){let e,i=t.$implicit,a=u().$implicit;l(),C((e=je(2,1,i.command,a.id))?1:3,e)}}function qa(n,t){if(n&1&&(R(0,18),f(1,La,2,1,"th",32)(2,Ua,4,4,"td",21),j()),n&2){let e=t.$implicit;p("matColumnDef",e.id)}}function Ha(n,t){n&1&&d(0,"th",33)}function Wa(n,t){n&1&&d(0,"td",30)}function Qa(n,t){n&1&&d(0,"tr",34)}function za(n,t){if(n&1&&d(0,"tr",35),n&2){let e=t.$implicit,i=u(2);se("selected",i.selection.isSelected(e))}}function Ka(n,t){if(n&1&&(o(0,"table",6),R(1,11),f(2,Ea,2,0,"th",12)(3,Ma,3,2,"td",13),j(),R(4,14),f(5,Pa,2,0,"th",12)(6,Ia,3,2,"td",15),j(),R(7,16),f(8,$a,2,0,"th",12)(9,Ba,3,1,"td",17),j(),I(10,qa,3,1,"ng-container",18,A),y(12,"async"),R(13,19),f(14,Ha,1,0,"th",20)(15,Wa,1,0,"td",21),j(),f(16,Qa,1,0,"tr",22),y(17,"async"),f(18,za,1,2,"tr",23),y(19,"async"),r()),n&2){let e=u(),i=J(8);p("dataSource",e.dataSource),l(10),$(k(12,3,e.aliasColumns$)),l(6),p("matHeaderRowDef",k(17,5,i.displayedColumns$)),l(2),p("matRowDefColumns",k(19,7,i.displayedColumns$))}}var Zt=class n{constructor(t,e){this.yamcs=t;this.changeDetection=e;this.pageSize=100;this.system=null;this.breadcrumb$=new V([]);this.filterControl=new Zi;this.columns=[{id:"name",label:"Name",alwaysVisible:!0},{id:"significance",label:"Significance",visible:!0},{id:"shortDescription",label:"Description"},{id:"actions",label:"",alwaysVisible:!0}];this.aliasColumns$=new V([]);this.selection=new St(!1);this.selectedCommand$=new V(null);this.onChange=t=>{};this.onTouched=()=>{};this.dataSource=new zn(t),this.selectedCommand$.subscribe(async i=>{if(i&&i.command){let a=await this.yamcs.yamcsClient.getCommand(this.yamcs.instance,i.command.qualifiedName);return this.onChange(a)}else return this.onChange(null)})}ngAfterViewInit(){this.changeSystem(""),this.searchFilter.filter.nativeElement.focus(),this.filterControl.valueChanges.subscribe(()=>{this.paginator.pageIndex=0,this.updateDataSource()}),this.paginator.page.subscribe(()=>{this.updateDataSource(),this.top.nativeElement.scrollIntoView()})}changeSystem(t,e=0){this.system=t,this.updateBrowsePath(),this.paginator.pageIndex=e,this.updateDataSource()}updateDataSource(){let t={system:this.system||"/",noAbstract:!0,details:!0,pos:this.paginator.pageIndex*this.pageSize,limit:this.pageSize,fields:["name","qualifiedName","alias","effectiveSignificance","shortDescription"]},e=this.filterControl.value;e&&(t.q=e.toLowerCase()),this.dataSource.loadCommands(t).then(()=>{this.selection.clear(),this.updateBrowsePath();for(let a of this.aliasColumns$.value){let s=this.columns.indexOf(a);s!==-1&&this.columns.splice(s,1)}let i=[];for(let a of this.dataSource.getAliasNamespaces()){let s={id:a,label:a,alwaysVisible:!0};i.push(s)}this.columns.splice(1,0,...i),this.aliasColumns$.next(i),this.columnChooser.recalculate(this.columns)})}selectRow(t){return t.system?(this.selectedCommand$.next(null),this.changeSystem(t.name)):this.selectedCommand$.next(t),!1}updateBrowsePath(){let t=[],e="";if(this.system)for(let i of this.system.slice(1).split("/"))e+="/"+i,t.push({name:i,system:e});this.breadcrumb$.next(t)}selectNext(){let t=this.dataSource.items$.value,e=0;if(this.selection.hasValue()){let i=this.selection.selected[0];t.indexOf(i)!==-1&&(e=Math.min(t.indexOf(i)+1,t.length-1))}this.selection.select(t[e])}selectPrevious(){let t=this.dataSource.items$.value,e=0;if(this.selection.hasValue()){let i=this.selection.selected[0];t.indexOf(i)!==-1&&(e=Math.max(t.indexOf(i)-1,0))}this.selection.select(t[e])}applySelection(){if(this.selection.hasValue()){let t=this.selection.selected[0],e=this.dataSource.items$.value;t.command&&e.indexOf(t)!==-1&&this.selectRow(t)}}writeValue(t){this.path=t}registerOnChange(t){this.onChange=t}registerOnTouched(t){this.onTouched=t}static{this.\u0275fac=function(e){return new(e||n)(g(M),g(gt))}}static{this.\u0275cmp=b({type:n,selectors:[["app-command-selector"]],viewQuery:function(e,i){if(e&1&&(te(va,7),te(Vt,5),te(Rt,5),te(Sa,5)),e&2){let a;ie(a=ne())&&(i.top=a.first),ie(a=ne())&&(i.paginator=a.first),ie(a=ne())&&(i.columnChooser=a.first),ie(a=ne())&&(i.searchFilter=a.first)}},inputs:{path:"path"},features:[Gi([{provide:Ji,useExisting:Ai(()=>n),multi:!0}])],decls:12,vars:12,consts:[["top",""],["searchFilter",""],["columnChooser",""],[1,"filter-bar"],["placeholder","Search by name","icon","search",3,"onArrowDown","onArrowUp","onEnter","formControl"],["preferenceKey","sendCommand",3,"columns"],["mat-table","",1,"ya-data-table","expand",3,"dataSource"],[3,"pageSize","hidePageSize","showFirstLastButtons","length"],["icon","account_tree",3,"click","action"],[3,"action","label"],[3,"click","action","label"],["cdkColumnDef","name"],["mat-header-cell","",4,"cdkHeaderCellDef"],["mat-cell","","class","primary-td",4,"cdkCellDef"],["cdkColumnDef","shortDescription"],["mat-cell","","class","wrap200",4,"cdkCellDef"],["cdkColumnDef","significance"],["mat-cell","",4,"cdkCellDef"],[3,"matColumnDef"],["matColumnDef","actions"],["mat-header-cell","","class","expand",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",3,"selected",4,"matRowDef","matRowDefColumns"],["mat-header-cell",""],["mat-cell","",1,"primary-td"],[1,"icon12",2,"vertical-align","middle"],["href","",3,"click"],[3,"text","term"],["mat-cell","",1,"wrap200"],["mat-cell",""],[3,"level"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-header-cell","",1,"expand"],["mat-header-row",""],["mat-row",""]],template:function(e,i){if(e&1){let a=w();d(0,"span",null,0),f(2,ba,1,1),y(3,"async"),o(4,"div",3)(5,"ya-search-filter",4,1),_("onArrowDown",function(){return v(a),S(i.selectNext())})("onArrowUp",function(){return v(a),S(i.selectPrevious())})("onEnter",function(){return v(a),S(i.applySelection())}),r(),d(7,"ya-column-chooser",5,2),r(),f(9,Ka,20,9,"table",6),d(10,"mat-paginator",7),y(11,"async")}if(e&2){let a;l(2),C((a=k(3,8,i.breadcrumb$))?2:-1,a),l(3),p("formControl",i.filterControl),l(2),p("columns",i.columns),l(2),C(i.dataSource?9:-1),l(),p("pageSize",i.pageSize)("hidePageSize",!0)("showFirstLastButtons",!0)("length",k(11,10,i.dataSource.totalSize$))}},dependencies:[Rn,E,re,Hi,N,en,Tt,Mt,Pt,_e,Vt,Fe,Nt,gn,Me,Te,qe,Ot,Pe,At,Ve,$t,It,Rt,Dn,Tn,Vn,Ut],styles:[".pullRight[_ngcontent-%COMP%]{float:right}.primary-td[_ngcontent-%COMP%]   .mat-icon[_ngcontent-%COMP%]{margin-right:7px}"],changeDetection:0})}};var ti=class{constructor(t){this.step=t}getAssignment(t){for(let e in this.step.args)if(e===t){let i=this.step.args[e];return oe.toValue(i)}}getOption(t,e){for(let i in this.step.extra||{})if(i===t){let a=this.step.extra[i];switch(e){case"BOOLEAN":return this.getBooleanOption(a);case"NUMBER":return this.getNumberOption(a);case"STRING":return this.getStringOption(a);case"TIMESTAMP":return this.getStringOption(a)}}}getBooleanOption(t){if(t.type==="BOOLEAN")return t}getNumberOption(t){switch(t.type){case"SINT32":case"UINT32":case"SINT64":case"UINT64":return t}}getStringOption(t){if(t.type==="STRING")return t}getComment(){return this.step.comment}getStream(){return this.step.stream}getAdvancementParams(){return this.step.advancement}};var Xa=["commandSelector"],Ja=["commandForm"],Za=()=>[];function eo(n,t){if(n&1&&(o(0,"div",2)(1,"form",3)(2,"h2"),c(3,"Select command"),r(),o(4,"div",4),d(5,"app-command-selector",5,0),r()()(),o(7,"div",6)(8,"mat-toolbar")(9,"mat-toolbar-row")(10,"ya-button",7),c(11,"CANCEL"),r()()()()),n&2){let e=u();l(),p("formGroup",e.selectCommandForm)}}function to(n,t){if(n&1){let e=w();o(0,"ya-text-action",13),_("click",function(){let a=v(e),s=u(2);return S(s.returnToList(a))}),c(1),r()}n&2&&(p("padding",!1),l(),D(" ",t," "))}function io(n,t){if(n&1&&(o(0,"div"),c(1),d(2,"br"),o(3,"h2"),c(4),r()()),n&2){let e=t.$implicit;l(),D(" ",e.namespace," "),l(3),ue(e.name)}}function no(n,t){if(n&1){let e=w();o(0,"div",2)(1,"div",8)(2,"div",9)(3,"div"),f(4,to,2,2,"ya-text-action",10),y(5,"spaceSystemName"),o(6,"h2"),c(7),r()(),I(8,io,5,2,"div",null,A),r(),d(10,"app-command-form",11,1),r()(),o(12,"div",6)(13,"mat-toolbar")(14,"mat-toolbar-row")(15,"ya-button",7),c(16,"CANCEL"),r(),c(17," \xA0\xA0 "),o(18,"ya-button",12),_("click",function(){v(e);let a=u();return S(a.handleOK())}),c(19),r()()()()}if(n&2){let e,i=t,a=J(11),s=u();l(4),C((e=k(5,7,i.qualifiedName))?4:-1,e),l(3),ue(i.name),l(),$(i.alias||Ye(9,Za)),l(2),p("command",i)("templateProvider",s.templateProvider)("stackMode",!0),l(8),p("disabled",!a.form.valid),l(),D(" ",s.okLabel," ")}}var pt=class n{constructor(t,e,i,a,s){this.dialogRef=t;this.yamcs=e;this.changeDetection=a;this.data=s;this.okLabel="OK";this.commandFormValid$=new V(!1);this.selectedCommand$=new V(null);if(s?.entry){let m=s.entry;this.templateProvider=new ti(m.model),this.selectedCommand$.next(m.command??null)}s?.okLabel&&(this.okLabel=s?.okLabel),this.selectCommandForm=i.group({command:["",B.required]}),this.selectCommandForm.valueChanges.subscribe(()=>{let m=this.selectCommandForm.value.command;this.selectedCommand$.next(m||null)})}handleOK(){let t=this.commandForm.getResult(),e={command:this.selectedCommand$.value,args:t.args,extra:t.extra,comment:t.comment,stream:t.stream,advancement:t.advancement};this.dialogRef.close(e)}returnToList(t){this.templateProvider=null,this.selectedCommand$.next(null),this.changeDetection.detectChanges(),this.selectCommandForm.reset(),this.commandSelector.changeSystem(t==="/"?"":t)}static{this.\u0275fac=function(e){return new(e||n)(g(q),g(M),g(le),g(gt),g(Z))}}static{this.\u0275cmp=b({type:n,selectors:[["ng-component"]],viewQuery:function(e,i){if(e&1&&(te(Xa,5),te(Ja,5)),e&2){let a;ie(a=ne())&&(i.commandSelector=a.first),ie(a=ne())&&(i.commandForm=a.first)}},decls:4,vars:6,consts:[["commandSelector",""],["commandForm",""],[1,"wrapper"],[1,"ya-form",3,"formGroup"],[1,"command-table-wrapper"],["formControlName","command"],[1,"footer"],["mat-dialog-close",""],[1,"command-detail"],[1,"names",2,"margin-bottom","0.5em"],[3,"padding"],[3,"command","templateProvider","stackMode"],["appearance","primary",3,"click","disabled"],[3,"click","padding"]],template:function(e,i){if(e&1&&(f(0,eo,12,1),y(1,"async"),f(2,no,20,10),y(3,"async")),e&2){let a;C(k(1,2,i.selectedCommand$)?-1:0),l(2),C((a=k(3,4,i.selectedCommand$))?2:-1,a)}},dependencies:[Wn,Zt,E,re,Y,N,L,G,U,H,Dt,ln,T,ze,On],styles:[".mat-mdc-dialog-container{border-radius:0;position:relative}.wrapper[_ngcontent-%COMP%]{position:relative;height:calc(100% - 48px);overflow:auto;font:400 12px/20px Roboto,sans-serif}.command-table-wrapper[_ngcontent-%COMP%]{position:absolute;overflow:auto;inset:56px 0 1em}.command-detail[_ngcontent-%COMP%]{max-width:600px}.footer[_ngcontent-%COMP%]{position:absolute;bottom:0;height:64px;left:0;right:0;border-top:1px solid #d3d3d3}.disabled[_ngcontent-%COMP%]   .label[_ngcontent-%COMP%]{opacity:.6}div.names[_ngcontent-%COMP%]{display:flex}div.names[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{padding-right:25px}div.names[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]:not(:first-child){padding-left:25px;border-left:1px solid rgba(0,0,0,.1)}div.names[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0}div.names[_ngcontent-%COMP%]     .text-action{line-height:0}"]})}};var ao=["textContainer"],dt=class n{constructor(t,e){this.dialogRef=t;this.data=e;this.textContainerRef=$i.required("textContainer");this.text=ot("")}ngAfterViewInit(){this.text.set(this.data.entry?.text||"");let t=[sn,ct.lineWrapping,Hn(),ct.updateListener.of(i=>{if(i.docChanged){let a=i.state.doc.toString();this.text.set(a)}})],e=ct.theme({"&":{height:"100%",fontSize:"12px"},".cm-scroller":{overflow:"auto",fontFamily:"'Roboto Mono', monospace"},"&.cm-focused":{outline:"none"}},{dark:!1});t.push(e),this.editorView=new ct({doc:this.text(),extensions:t,parent:this.textContainerRef().nativeElement}),this.editorView.focus()}save(){let t=this.editorView?.state.doc.toString()||"";this.dialogRef.close(t)}gotoMarkdownDocs(){window.open("https://www.markdownguide.org/basic-syntax/","_blank","noreferrer")}ngOnDestroy(){this.editorView?.destroy()}static{this.\u0275fac=function(e){return new(e||n)(g(q),g(Z))}}static{this.\u0275cmp=b({type:n,selectors:[["app-edit-text-entry-dialog"]],viewQuery:function(e,i){e&1&&Li(i.textContainerRef,ao,5),e&2&&Yi()},decls:18,vars:3,consts:[["textContainer",""],["mat-dialog-title",""],["animationDuration","0ms",1,"small-tabs",3,"mat-stretch-tabs"],["label","Write"],[1,"text-container"],["label","Preview"],[1,"preview-container"],[3,"text"],["align","end"],["appearance","text","icon","open_in_new",3,"click"],[2,"flex","1 1 auto"],["mat-dialog-close",""],["appearance","primary",3,"click"]],template:function(e,i){if(e&1){let a=w();o(0,"h2",1),c(1,"Step: Display text"),r(),o(2,"mat-dialog-content")(3,"mat-tab-group",2)(4,"mat-tab",3),d(5,"div",4,0),r(),o(7,"mat-tab",5)(8,"div",6),d(9,"app-markdown",7),r()()()(),o(10,"mat-dialog-actions",8)(11,"ya-button",9),_("click",function(){return v(a),S(i.gotoMarkdownDocs())}),c(12," Markdown syntax "),r(),d(13,"div",10),o(14,"ya-button",11),c(15,"CANCEL"),r(),o(16,"ya-button",12),_("click",function(){return v(a),S(i.save())}),c(17),r()()}e&2&&(l(3),p("mat-stretch-tabs",!1),l(6),p("text",i.text()),l(8),D(" ",i.data.edit?"UPDATE":"ADD TO STACK"," "))},dependencies:[tt,E,H,ee,X,K,Cn,yn,T],styles:[".text-container[_ngcontent-%COMP%]{border:1px solid rgba(0,0,0,.1);margin-top:12px;height:300px}.preview-container[_ngcontent-%COMP%]{border:1px solid rgba(0,0,0,.1);background-color:#fafafa;margin-top:12px;height:300px}"]})}};function oo(n,t){if(n&1){let e=w();o(0,"tr",5)(1,"td",18),d(2,"app-parameter-input",19),r(),o(3,"td",20)(4,"ya-select",21),d(5,"ya-option",22)(6,"ya-option",23)(7,"ya-option",24)(8,"ya-option",25)(9,"ya-option",26)(10,"ya-option",27),r()(),o(11,"td",28),d(12,"input",29),r(),o(13,"td",20)(14,"ya-icon-action",30),_("click",function(){let a=v(e).$index,s=u();return S(s.moveComparisonGroupDown(a))}),r(),o(15,"ya-icon-action",31),_("click",function(){let a=v(e).$index,s=u();return S(s.moveComparisonGroupUp(a))}),r(),o(16,"ya-text-action",32),_("click",function(){let a=v(e).$index,s=u();return S(s.removeComparisonGroup(a))}),c(17," DELETE "),r()()()}if(n&2){let e=t.$index,i=t.$count;p("formGroupName",e),l(14),p("disabled",e===i-1),l(),p("disabled",e===0)}}var ut=class n{constructor(t,e){this.dialogRef=t;this.data=e;if(this.form=new Be({condition:new bt([]),delay:new ce(0,[B.required]),timeout:new ce(""),comment:new ce("")}),e.entry){let i=e.entry.condition||[];for(let a of i)this.addComparisonGroup();this.form.setValue({condition:i,delay:e.entry.delay??0,timeout:e.entry.timeout||"",comment:e.entry.comment||""})}this.conditionFormArray.length||this.addComparisonGroup()}get conditionFormArray(){return this.form.controls.condition}get comparisonGroups(){return this.conditionFormArray.controls}addComparisonGroup(){this.conditionFormArray.push(new Be({parameter:new ce("",[B.required]),operator:new ce("eq",[B.required]),value:new ce("",[B.required])}))}removeComparisonGroup(t){this.conditionFormArray.removeAt(t)}moveComparisonGroupDown(t){let e=this.conditionFormArray.controls[t];this.conditionFormArray.removeAt(t),this.conditionFormArray.insert(t+1,e)}moveComparisonGroupUp(t){let e=this.conditionFormArray.controls[t];this.conditionFormArray.removeAt(t),this.conditionFormArray.insert(t-1,e)}save(){let{value:t}=this.form,e={condition:t.condition,delay:Math.max(t.delay,0),comment:t.comment};t.timeout!==""&&t.timeout!==null&&(e.timeout=Math.max(t.timeout,0)),this.dialogRef.close(e)}static{this.\u0275fac=function(e){return new(e||n)(g(q),g(Z))}}static{this.\u0275cmp=b({type:n,selectors:[["app-edit-verify-entry-dialog"]],decls:34,vars:4,consts:[["mat-dialog-title",""],[1,"ya-form",3,"formGroup"],["label","Parameters",3,"expanded"],[1,"label"],["formArrayName","condition",1,"condition-table"],[3,"formGroupName"],["colspan","1"],["icon","add_circle_outline",3,"click"],["label","Timing"],["type","number","formControlName","delay"],[1,"hint"],["type","number","formControlName","timeout"],["label","Comment"],["formControlName","comment"],["align","end"],[2,"flex","1 1 auto"],["mat-dialog-close",""],["appearance","primary",3,"click","disabled"],[2,"width","70%"],["formControlName","parameter"],[2,"white-space","nowrap"],["formControlName","operator",1,"operator"],["id","eq","label","="],["id","neq","label","!="],["id","lt","label","<"],["id","lte","label","<="],["id","gt","label",">"],["id","gte","label",">="],[2,"width","30%"],["type","text","formControlName","value"],["icon","keyboard_arrow_down",3,"click","disabled"],["icon","keyboard_arrow_up",3,"click","disabled"],["icon","delete",3,"click"]],template:function(e,i){e&1&&(o(0,"h2",0),c(1,"Step: Verify parameters"),r(),o(2,"mat-dialog-content")(3,"form",1)(4,"ya-stepper")(5,"ya-stepper-step",2)(6,"div",3)(7,"table",4),I(8,oo,18,3,"tr",5,A),o(10,"tr")(11,"td",6)(12,"ya-button",7),_("click",function(){return i.addComparisonGroup()}),c(13," \xA0Add "),r()()()()()(),o(14,"ya-stepper-step",8)(15,"div",3),c(16," Delay (milliseconds) "),d(17,"input",9),o(18,"span",10),c(19,"Initial delay before verifying the condition"),r()(),d(20,"br"),o(21,"div",3),c(22," Timeout (milliseconds) "),d(23,"input",11),o(24,"span",10),c(25,"Maximum wait time before aborting the verification"),r()()(),o(26,"ya-stepper-step",12),d(27,"app-markdown-input",13),r()()()(),o(28,"mat-dialog-actions",14),d(29,"div",15),o(30,"ya-button",16),c(31,"CANCEL"),r(),o(32,"ya-button",17),_("click",function(){return i.save()}),c(33),r()()),e&2&&(l(3),p("formGroup",i.form),l(2),p("expanded",!0),l(3),$(i.comparisonGroups),l(24),p("disabled",!i.form.valid),l(),D(" ",i.data.edit?"UPDATE":"ADD TO STACK"," "))},dependencies:[qt,Ht,Pn,Mn,E,Y,fe,kt,N,L,G,U,tn,xt,H,ee,X,K,T,We,En,Qe,ze],styles:[".condition-table[_ngcontent-%COMP%]{width:100%}.condition-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:first-child{margin-left:0;padding-left:0}[_nghost-%COMP%]     .condition-table input{margin:0!important}[_nghost-%COMP%]     ya-select.operator ya-button{margin-top:0;width:100%}"],changeDetection:0})}};var ii=class n{constructor(t,e){this.dialogRef=t;this.form=e.group({executionTime:["",[B.required]],tags:[[],[]]})}schedule(){this.dialogRef.close(this.form.value)}static{this.\u0275fac=function(e){return new(e||n)(g(q),g(le))}}static{this.\u0275cmp=b({type:n,selectors:[["app-schedule-stack-dialog"]],decls:26,vars:4,consts:[["mat-dialog-title",""],[1,"hint"],[1,"ya-form",3,"formGroup"],[1,"label"],["formControlName","executionTime",3,"showMillis","showNow"],[1,"half-break"],["dialogTitle","Timeline Tags"],["formControlName","tags"],["align","end"],[2,"flex","1 1 auto"],["mat-dialog-close",""],["appearance","primary",3,"click","disabled"]],template:function(e,i){e&1&&(o(0,"h2",0),c(1,"Run later"),r(),o(2,"mat-dialog-content")(3,"div",1)(4,"p"),c(5,"This stack will be submitted to the Yamcs Timeline, for execution at a later time."),r()(),o(6,"form",2)(7,"div",3),c(8," Execution time "),d(9,"br")(10,"ya-date-time-input",4),r(),d(11,"hr",5),o(12,"div",3),c(13," Timeline tags "),o(14,"span",1),c(15,"(optional)"),r(),o(16,"ya-help",6),c(17," Tags allow to categorise items per band. Bands only show items for which one of the tags is matching. "),r(),d(18,"br")(19,"ya-tag-select",7),r()()(),o(20,"mat-dialog-actions",8),d(21,"div",9),o(22,"ya-button",10),c(23,"CANCEL"),r(),o(24,"ya-button",11),_("click",function(){return i.schedule()}),c(25,"SCHEDULE"),r()()),e&2&&(l(6),p("formGroup",i.form),l(4),p("showMillis",!0)("showNow",!0),l(14),p("disabled",!i.form.valid))},dependencies:[E,Y,N,L,G,U,H,ee,X,K,T,jt,Ke,Yt],encapsulation:2,changeDetection:0})}};var Re=class n{constructor(){this.icon=W.required();this.text=W.required()}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275cmp=b({type:n,selectors:[["app-entry-label"]],inputs:{icon:[1,"icon"],text:[1,"text"]},decls:4,vars:2,consts:[[1,"icon12"]],template:function(e,i){e&1&&(o(0,"mat-icon",0),c(1),r(),o(2,"span"),c(3),r()),e&2&&(l(),ue(i.icon()),l(2),ue(i.text()))},dependencies:[_e],styles:["[_nghost-%COMP%]{display:flex;align-items:center;background-color:inherit;font-size:12px;font-weight:400;font-family:Roboto Mono,monospace;line-height:12px;letter-spacing:.02em;color:#000000a7;padding:2px;margin-bottom:5px}span[_ngcontent-%COMP%]{margin-left:5px}"],changeDetection:0})}};function ro(n,t){if(n&1&&(o(0,"td",9),c(1),r()),n&2){let e=t.$implicit;l(),D(" ",e.parameter," ")}}function co(n,t){if(n&1&&d(0,"app-alarm-level",11),n&2){let e=u().$implicit;p("level",e.pval.monitoringResult)}}function lo(n,t){if(n&1&&(o(0,"td",10),f(1,co,1,1,"app-alarm-level",11),r()),n&2){let e,i=t.$implicit;l(),C((e=i.pval==null?null:i.pval.engValue)?1:-1,e)}}function so(n,t){n&1&&(o(0,"span"),c(1,"\u2193"),r())}function mo(n,t){n&1&&(o(0,"span"),c(1,"\u2191"),r())}function po(n,t){if(n&1&&(o(0,"ya-expirable",13),d(1,"ya-value",14),f(2,so,2,0,"span")(3,mo,2,0,"span"),r()),n&2){let e=u().$implicit;p("pval",e.pval),l(),p("value",e.pval.engValue)("alwaysExpand",!0),l(),C(e.pval.rangeCondition==="LOW"?2:-1),l(),C(e.pval.rangeCondition==="HIGH"?3:-1)}}function uo(n,t){n&1&&c(0," - ")}function fo(n,t){if(n&1&&(o(0,"td",12),f(1,po,4,5,"ya-expirable",13)(2,uo,1,0),r()),n&2){let e,i=t.$implicit;l(),C((e=i.pval==null?null:i.pval.engValue)?1:2,e)}}function _o(n,t){n&1&&d(0,"tr",15)}function go(n,t){if(n&1&&(o(0,"table",1),R(1,2),f(2,ro,2,1,"td",3),j(),R(3,4),f(4,lo,2,1,"td",5),j(),R(5,6),f(6,fo,3,1,"td",7),j(),f(7,_o,1,0,"tr",8),r()),n&2){let e=u();p("dataSource",e.dataSource),l(7),p("matRowDefColumns",e.displayedColumns)}}var ni=class n{constructor(){this.entry=W.required();this.pvals=W.required();this.dataSource=new He;this.displayedColumns=["parameter","level","value"];yt(()=>{let t=this.pvals(),e=[];for(let i of this.entry().parameters){let a={parameter:i.parameter,pval:t[i.parameter]};e.push(a)}this.dataSource.data=e})}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275cmp=b({type:n,selectors:[["app-stacked-check-entry"]],inputs:{entry:[1,"entry"],pvals:[1,"pvals"]},decls:2,vars:1,consts:[["icon","toll","text","Parameters:"],["mat-table","",1,"ya-data-table","no-frame",3,"dataSource"],["matColumnDef","parameter"],["mat-cell","","style","width: 400px",4,"matCellDef"],["matColumnDef","level"],["mat-cell","","style","width: 80px",4,"matCellDef"],["matColumnDef","value"],["mat-cell","",4,"matCellDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["mat-cell","",2,"width","400px"],["mat-cell","",2,"width","80px"],[3,"level"],["mat-cell",""],[3,"pval"],[3,"value","alwaysExpand"],["mat-row",""]],template:function(e,i){if(e&1&&(d(0,"app-entry-label",0),f(1,go,8,2,"table",1)),e&2){let a;l(),C((a=i.entry())?1:-1,a)}},dependencies:[Ln,Re,E,Fe,Me,Te,qe,Pe,Ve,Lt,Ze],styles:["[_nghost-%COMP%]{display:block;position:relative}table[_ngcontent-%COMP%]{padding-left:18px;padding-right:18px;background-color:#fafafa}[_nghost-%COMP%]     tr.mat-mdc-row{background:#fafafa}[_nghost-%COMP%]     td:first-child{padding-left:0!important}"],changeDetection:0})}};var ai=class n{transform(t){return t?t==="CommandComplete"?"Completed":t.replace("Acknowledge_",""):null}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275pipe=Ri({name:"acknowledgmentName",type:n,pure:!0})}};function Co(n,t){if(n&1&&(o(0,"span"),c(1),y(2,"value"),r()),n&2){let e=t.$implicit;l(),hi("[",e.key,": ",k(2,2,e.value),"]")}}function yo(n,t){if(n&1&&(o(0,"tr")(1,"td",3),c(2),r(),o(3,"td",4),d(4,"ya-value",5),y(5,"tovalue"),r()()),n&2){let e=t.$implicit;l(2),D(" ",e.key," "),l(2),p("value",k(5,2,e.value))}}function ho(n,t){if(n&1&&(o(0,"span"),c(1),y(2,"acknowledgmentName"),r()),n&2){let e=u(2);l(),hi(" Advance when ",k(2,2,e.advancement.acknowledgment)," ",e.advancement.wait!=null?"+ "+e.advancement.wait+" ms":null," ")}}function vo(n,t){if(n&1&&(o(0,"span"),c(1),r()),n&2){let e=u(2);l(),D("Advance after ",e.advancement.wait," ms")}}function So(n,t){if(n&1&&(o(0,"div",2)(1,"mat-icon"),c(2,"reply"),r(),f(3,ho,3,4,"span")(4,vo,2,1,"span"),r()),n&2){let e=u();l(3),C(e.advancement.acknowledgment?3:e.advancement.wait!=null?4:-1)}}function ko(n,t){if(n&1&&(d(0,"app-entry-label",0),I(1,Co,3,4,"span",null,A),y(3,"keyvalue"),o(4,"table",1),I(5,yo,6,4,"tr",null,A),y(7,"keyvalue"),r(),f(8,So,5,1,"div",2)),n&2){let e=t,i=u();p("text","Command: "+e.name),l(),$(k(3,2,e.extra)),l(4),$(je(7,4,e.args,i.insertionOrder)),l(3),C(e.advancement?8:-1)}}var oi=class n{constructor(){this.entry=W.required();this.insertionOrder=(t,e)=>0}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275cmp=b({type:n,selectors:[["app-stacked-command-entry"]],inputs:{entry:[1,"entry"]},decls:1,vars:1,consts:[["icon","rss_feed",3,"text"],[1,"args"],[1,"advance-on"],["width","1",1,"key"],[1,"value"],[3,"value"]],template:function(e,i){if(e&1&&f(0,ko,9,7),e&2){let a;C((a=i.entry())?0:-1,a)}},dependencies:[ai,Re,E,qi,_e,Ze,An,Je],styles:["[_nghost-%COMP%]{display:block;position:relative}.advance-on[_ngcontent-%COMP%]{color:#000000a7;font-size:12px}.advance-on[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{vertical-align:middle}.advance-on[_ngcontent-%COMP%] > mat-icon[_ngcontent-%COMP%]{transform:rotate(180deg);font-size:12px;height:12px;width:12px}table.args[_ngcontent-%COMP%]{margin:0 0 0 18px;font-size:10px}table.args[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:0;border:0}table.args[_ngcontent-%COMP%]   td.key[_ngcontent-%COMP%]{min-width:120px;white-space:nowrap}table.args[_ngcontent-%COMP%]   td.value[_ngcontent-%COMP%]{color:gray;padding-left:10px}"],changeDetection:0})}};function xo(n,t){n&1&&d(0,"app-markdown",0),n&2&&p("text",t.renderedText())}var ri=class n{constructor(){this.entry=W.required()}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275cmp=b({type:n,selectors:[["app-stacked-text-entry"]],inputs:{entry:[1,"entry"]},decls:1,vars:1,consts:[[3,"text"]],template:function(e,i){if(e&1&&f(0,xo,1,1,"app-markdown",0),e&2){let a;C((a=i.entry())?0:-1,a)}},dependencies:[tt,E],styles:["[_nghost-%COMP%]{display:block;position:relative}"],changeDetection:0})}};function bo(n,t){n&1&&c(0," = ")}function Eo(n,t){n&1&&c(0," != ")}function wo(n,t){n&1&&c(0," < ")}function Do(n,t){n&1&&c(0," <= ")}function Fo(n,t){n&1&&c(0," > ")}function To(n,t){n&1&&c(0," >= ")}function Mo(n,t){if(n&1&&(o(0,"td",10),c(1),f(2,bo,1,0)(3,Eo,1,0)(4,wo,1,0)(5,Do,1,0)(6,Fo,1,0)(7,To,1,0),c(8),r()),n&2){let e,i=t.$implicit;l(),D(" ",i.parameter," "),l(),C((e=i.operator)==="eq"?2:e==="neq"?3:e==="lt"?4:e==="lte"?5:e==="gt"?6:e==="gte"?7:-1),l(6),D(" ",i.value," ")}}function Po(n,t){n&1&&(o(0,"span",12),c(1,"satisfied"),r())}function Vo(n,t){n&1&&(o(0,"span",13),c(1,"not satisfied"),r())}function No(n,t){if(n&1&&(o(0,"td",11),f(1,Po,2,0,"span",12)(2,Vo,2,0,"span",13),d(3,"app-live-expression",14,0),r()),n&2){let e=t.$implicit,i=J(4);l(),C(i.result()===!0?1:2),l(2),p("expression",e.expression)}}function Oo(n,t){n&1&&(o(0,"span"),c(1,"\u2193"),r())}function Ao(n,t){n&1&&(o(0,"span"),c(1,"\u2191"),r())}function Io(n,t){if(n&1&&(o(0,"ya-expirable",16),c(1),y(2,"value"),f(3,Oo,2,0,"span")(4,Ao,2,0,"span"),r()),n&2){let e=u().$implicit;p("pval",e.pval),l(),D(" ",k(2,4,e.pval.engValue)," "),l(2),C(e.pval.rangeCondition==="LOW"?3:-1),l(),C(e.pval.rangeCondition==="HIGH"?4:-1)}}function $o(n,t){n&1&&c(0," - ")}function Ro(n,t){if(n&1&&(o(0,"td",15),f(1,Io,5,6,"ya-expirable",16)(2,$o,1,0),r()),n&2){let e,i=t.$implicit;l(),C((e=i.pval==null?null:i.pval.engValue)?1:2,e)}}function jo(n,t){n&1&&d(0,"tr",17)}function Bo(n,t){if(n&1&&(o(0,"table",2),R(1,3),f(2,Mo,9,3,"td",4),j(),R(3,5),f(4,No,5,2,"td",6),j(),R(5,7),f(6,Ro,3,1,"td",8),j(),f(7,jo,1,0,"tr",9),r()),n&2){let e=u();p("dataSource",e.dataSource)("trackBy",e.tableTrackerFn),l(7),p("matRowDefColumns",e.displayedColumns)}}var ci=class n{constructor(){this.entry=W.required();this.pvals=W.required();this.dataSource=new He;this.displayedColumns=["expression","evaluation","value"];this.tableTrackerFn=(t,e)=>t;yt(()=>{let t=this.pvals(),e=[];for(let i of this.entry().condition){let a=`'${i.parameter}'`;switch(i.operator){case"eq":a+=" == ";break;case"neq":a+=" != ";break;case"lt":a+=" < ";break;case"lte":a+=" <= ";break;case"gt":a+=" > ";break;case"gte":a+=" >= ";break}typeof i.value=="string"?i.value==="true"?a+="true":i.value==="false"?a+="false":isNaN(i.value)?a+=`"${i.value}"`:a+=i.value:a+=`${i.value}`;let s={parameter:i.parameter,operator:i.operator,value:i.value,expression:a,pval:t[i.parameter]};e.push(s)}this.dataSource.data=e})}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275cmp=b({type:n,selectors:[["app-stacked-verify-entry"]],inputs:{entry:[1,"entry"],pvals:[1,"pvals"]},decls:2,vars:1,consts:[["expr",""],["icon","checklist_rtl","text","Verify:"],["mat-table","",1,"ya-data-table","no-frame",3,"dataSource","trackBy"],["matColumnDef","expression"],["mat-cell","","style","width: 400px",4,"matCellDef"],["matColumnDef","evaluation"],["mat-cell","","style","width: 80px",4,"matCellDef"],["matColumnDef","value"],["mat-cell","",4,"matCellDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["mat-cell","",2,"width","400px"],["mat-cell","",2,"width","80px"],[1,"evaluation","valid"],[1,"evaluation","invalid"],[2,"display","none",3,"expression"],["mat-cell",""],[3,"pval"],["mat-row",""]],template:function(e,i){if(e&1&&(d(0,"app-entry-label",1),f(1,Bo,8,3,"table",2)),e&2){let a;l(),C((a=i.entry())?1:-1,a)}},dependencies:[Re,Qn,E,Fe,Me,Te,qe,Pe,Ve,Lt,Je],styles:["[_nghost-%COMP%]{display:block;position:relative}table[_ngcontent-%COMP%]{padding-left:18px;padding-right:18px;background-color:#fafafa}[_nghost-%COMP%]     tr.mat-mdc-row{background:#fafafa}[_nghost-%COMP%]     td:first-child{padding-left:0!important}.evaluation[_ngcontent-%COMP%]{font-family:Roboto Mono,monospace;background-color:#ffeef0;color:red;padding-left:2px;padding-right:2px}.evaluation.valid[_ngcontent-%COMP%]{background-color:#e6ffed;color:#00c752}"],changeDetection:0})}};function Lo(n,t){n&1&&(o(0,"mat-icon",1),c(1,"check_circle_outline"),r())}function Yo(n,t){n&1&&(o(0,"mat-icon",2),c(1,"sync"),r())}function Go(n,t){n&1&&(o(0,"mat-icon",3),c(1,"highlight_off"),r())}function Uo(n,t){n&1&&(o(0,"mat-icon",4),c(1,"block"),r())}function qo(n,t){if(n&1&&f(0,Lo,2,0,"mat-icon",1)(1,Yo,2,0,"mat-icon",2)(2,Go,2,0,"mat-icon",3)(3,Uo,2,0,"mat-icon",4),n&2){let e,i=u();C((e=i.comparison.status())==="ok"?0:e==="pending"?1:e==="nok"?2:e==="cancelled"?3:-1)}}function Ho(n,t){n&1&&(o(0,"mat-icon",0),c(1,"lens"),r())}var li=class n{static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275cmp=b({type:n,selectors:[["app-verify-icon"]],inputs:{comparison:"comparison"},decls:2,vars:1,consts:[["matTooltip","Unknown",1,"icon16","nvl"],["matTooltip","Condition satisfied",1,"icon16","ok"],["matTooltip","Verifying condition",1,"icon16","pending"],["matTooltip","Condition not satisfied",1,"icon16","failed"],["matTooltip","Verification cancelled",1,"icon16","cancelled"]],template:function(e,i){e&1&&f(0,qo,4,1)(1,Ho,2,0,"mat-icon",0),e&2&&C(i.comparison.status?0:1)},dependencies:[E,_e,we],styles:["[_nghost-%COMP%]{line-height:0;font-size:0}.ok[_ngcontent-%COMP%]{color:#00c752}.pending[_ngcontent-%COMP%]{color:gray;animation:_ngcontent-%COMP%_yspin 2s infinite linear}.cancelled[_ngcontent-%COMP%]{color:gray}.failed[_ngcontent-%COMP%]{color:var(--y-error-color)}.nvl[_ngcontent-%COMP%]{color:gray}@keyframes _ngcontent-%COMP%_yspin{0%{-webkit-transform:rotate(0deg) scaleX(-1);transform:rotate(0) scaleX(-1)}to{-webkit-transform:rotate(359deg) scaleX(-1);transform:rotate(359deg) scaleX(-1)}}"],changeDetection:0})}};function Wo(n,t){if(n&1&&(o(0,"tr")(1,"td",0)(2,"div",1),d(3,"app-verify-icon",2),r()(),o(4,"td",3),c(5),r(),o(6,"td"),c(7),y(8,"value"),r()()),n&2){let e,i=t.$implicit;l(3),p("comparison",i),l(2),D(" ",i.parameter," "),l(2),ue((e=k(8,3,i.pval==null?null:i.pval.engValue))!==null&&e!==void 0?e:"-")}}var si=class n{static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275cmp=b({type:n,selectors:[["app-verify-table"]],inputs:{entry:"entry"},decls:3,vars:0,consts:[[2,"width","16px"],[2,"display","flex","align-items","center"],[3,"comparison"],[2,"padding-right","20px"]],template:function(e,i){e&1&&(o(0,"table"),I(1,Wo,9,5,"tr",null,A),r()),e&2&&(l(),$(i.entry.pvals))},dependencies:[li,E,Je],styles:["table[_ngcontent-%COMP%]{width:auto}table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{border:none;padding:0}table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:not(:first-child){padding-left:10px}table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{font-size:12px;line-height:16px}table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{color:#000000a7}"]})}};var zo=["entryParent"],Ko=n=>({c:n}),Xo=()=>[];function Jo(n,t){if(n&1){let e=w();o(0,"ya-page-button",27),_("clicked",function(){v(e);let a=u();return S(a.openScheduleStackDialog())}),c(1," Schedule "),r()}if(n&2){let e=u();p("disabled",!e.loaded||e.format!=="ycs"||!e.entries$.value.length)}}function Zo(n,t){n&1&&d(0,"ya-dots")}function er(n,t){n&1&&(o(0,"ya-empty-message")(1,"mat-icon",28),c(2,"link_off"),r(),c(3," Unsupported stack format "),r())}function tr(n,t){n&1&&(o(0,"ya-empty-message"),c(1," Empty stack "),d(2,"br"),c(3," Click "),o(4,"mat-icon",29),c(5,"add_circle_outline"),r(),c(6," to start adding steps "),r())}function ir(n,t){n&1&&c(0," [*]: ")}function nr(n,t){if(n&1&&c(0),n&2){let e=u().$implicit;D(" [",e.executionNumber,"]: ")}}function ar(n,t){n&1&&c(0," [ ]: ")}function or(n,t){if(n&1&&(d(0,"app-stacked-check-entry",34),y(1,"async")),n&2){let e=u().$implicit,i=u();p("entry",e)("pvals",k(1,2,i.pvals$))}}function rr(n,t){if(n&1&&d(0,"app-stacked-command-entry",35),n&2){let e=u().$implicit;p("entry",e)}}function cr(n,t){if(n&1&&d(0,"app-stacked-text-entry",35),n&2){let e=u().$implicit;p("entry",e)}}function lr(n,t){if(n&1&&(d(0,"app-stacked-verify-entry",34),y(1,"async")),n&2){let e=u().$implicit,i=u();p("entry",e)("pvals",k(1,2,i.pvals$))}}function sr(n,t){if(n&1&&(o(0,"div",36)(1,"div",38)(2,"mat-icon",39),c(3,"info"),r(),o(4,"span",40),c(5,"Info"),r()(),d(6,"app-markdown",41),r()),n&2){let e=u().$implicit;l(6),p("text",e.comment)}}function mr(n,t){if(n&1&&c(0),n&2){let e=u(2).$implicit;D(" ",e.err," ")}}function pr(n,t){if(n&1&&(o(0,"div",44),d(1,"app-extra-acknowledgments-table",43),r()),n&2){let e=u(3).$implicit;l(),p("command",e.record)("inline",!0)}}function dr(n,t){if(n&1&&(d(0,"app-yamcs-acknowledgments-table",43),f(1,pr,2,2,"div",44)),n&2){let e=u(2).$implicit;p("command",e.record)("inline",!0),l(),C(((e.record==null?null:e.record.extra)||Ye(3,Xo)).length?1:-1)}}function ur(n,t){n&1&&d(0,"ya-value",46),n&2&&p("value",t)}function fr(n,t){n&1&&c(0," - ")}function _r(n,t){if(n&1&&(o(0,"tr")(1,"td",45),c(2),r(),o(3,"td"),f(4,ur,1,1,"ya-value",46)(5,fr,1,0),r()()),n&2){let e,i=t.$implicit;l(2),ue(i.parameter),l(2),C((e=i.pval==null?null:i.pval.engValue)?4:5,e)}}function gr(n,t){if(n&1&&(o(0,"table"),I(1,_r,6,2,"tr",null,A),r()),n&2){let e=u(2).$implicit;l(),$(e.pvals)}}function Cr(n,t){if(n&1&&d(0,"app-verify-table",35),n&2){let e=u(2).$implicit;p("entry",e)}}function yr(n,t){if(n&1){let e=w();o(0,"div",37)(1,"div",42),_("click",function(){v(e);let a=u().$implicit,s=u();return S(s.selectEntry(a))}),r(),o(2,"div",33),f(3,mr,1,1)(4,dr,2,4)(5,gr,3,0,"table")(6,Cr,1,1,"app-verify-table",35),r()()}if(n&2){let e=u().$implicit;l(2),se("err",e.err),l(),C(e.err?3:e.type==="command"?4:e.type==="check"?5:e.type==="verify"?6:-1)}}function hr(n,t){if(n&1){let e=w();o(0,"div",30),y(1,"async"),_("click",function(){let a=v(e).$implicit,s=u();return S(s.selectEntry(a))})("dblclick",function(){let a=v(e).$implicit,s=u();return S(s.editEntry(a))}),o(2,"div",31)(3,"div",32),f(4,ir,1,0)(5,nr,1,1)(6,ar,1,0),r(),o(7,"div",33),f(8,or,2,4,"app-stacked-check-entry",34)(9,rr,1,1,"app-stacked-command-entry",35)(10,cr,1,1,"app-stacked-text-entry",35)(11,lr,2,4,"app-stacked-verify-entry",34)(12,sr,7,1,"div",36),r()(),f(13,yr,7,3,"div",37),r()}if(n&2){let e=t.$implicit,i=u();se("display-text",e.type==="text")("selected",e===k(1,8,i.selectedEntry$)),l(4),C(e.executing?4:e.executionNumber===0||e.executionNumber?5:e.executionNumber!==0&&!e.executionNumber?6:-1),l(4),C(e.type==="check"?8:e.type==="command"?9:e.type==="text"?10:e.type==="verify"?11:-1),l(4),C(e.comment?12:-1),l(),C(e.hasOutputs()?13:-1)}}var mi=class n{constructor(t,e,i,a,s,m,h,x,Q){this.dialog=t;this.yamcs=e;this.title=i;this.authService=a;this.configService=s;this.messageService=m;this.sanitizer=h;this.appearanceService=x;this.stackFileService=Q;this.running$=new V(!1);this.runningStack=!1;this.stepScopedSubscriptions=[];this.selectedEntry$=new V(null);this.clipboardEntry$=new V(null);this.commandHistoryRecords=new Map;this.executionCounter=0;this.loaded=!1;this.nextEntryScheduled=!1;this.idMapping={};this.pvals$=new V({});this.bucket=s.getStackBucket(),this.entries$=Q.entries$,this.hasState$=Q.hasState$,this.parameterSubscription=e.yamcsClient.createParameterSubscription({instance:e.instance,processor:e.processor,action:"REPLACE",abortOnInvalid:!1,sendFromCache:!0,updateOnExpiration:!0,id:[]},Ce=>{if(Ce.mapping&&(this.idMapping=Ce.mapping),Ce.values){let at=z({},this.pvals$.value);for(let Di of Ce.values){let Fi=this.idMapping[Di.numericId];Fi&&(at[Fi.name]=Di)}this.pvals$.next(at)}})}ngOnInit(){let t=this.objectName.lastIndexOf("/");if(t===-1)this.folderLink="/procedures/stacks/browse/",this.filename=this.objectName;else{let a=this.objectName.substring(0,t);this.folderLink="/procedures/stacks/browse/"+a,this.filename=this.objectName.substring(t+1)}this.title.setTitle(this.filename);let e=oe.getExtension(oe.getFilename(this.objectName))?.toLowerCase();if(e==="ycs"||e==="xml")this.format=e;else{this.loaded=!0;return}let i=this.stackFileService.entries;this.stackFileService.updateEntries(i),this.selectedEntry$.next(i.length?i[0]:null),this.updateParameterSubscription(),this.loaded=!0,this.commandSubscription=this.yamcs.yamcsClient.createCommandSubscription({instance:this.yamcs.instance,processor:this.yamcs.processor,ignorePastCommands:!0},a=>{let s=a.id,m=this.commandHistoryRecords.get(s);m?m=m.mergeEntry(a):m=new kn(a),this.commandHistoryRecords.set(s,m);for(let x of this.stackFileService.entries$.value)if(x instanceof pe&&x.id===s){x.record=m;break}let h=this.selectedEntry$.value;h&&h instanceof pe&&this.checkAckContinueRunning(h,m)})}handleDrop(t){t.previousIndex!==t.currentIndex&&(mn(this.entries$.value,t.previousIndex,t.currentIndex),this.stackFileService.updateEntries([...this.entries$.value]),this.stackFileService.markDirty())}updateParameterSubscription(){let t=new Set;for(let i of this.stackFileService.entries$.value)if(i.type==="check")for(let a of i.parameters)t.add(a.parameter);else if(i.type==="verify")for(let a of i.condition)t.add(a.parameter);let e=[];t.forEach(i=>e.push({name:i})),this.parameterSubscription.addReplyListener(()=>{this.parameterSubscription.sendMessage({action:"REPLACE",instance:this.yamcs.instance,processor:this.yamcs.processor,abortOnInvalid:!1,sendFromCache:!0,updateOnExpiration:!0,id:e})})}selectEntry(t){this.selectedEntry$.next(t)}deleteSelectedCommands(){let t=this.selectedEntry$.value;if(t){let e=this.entries$.value.indexOf(t);e!==-1&&(this.entries$.value.splice(e,1),this.selectedEntry$.next(null),this.stackFileService.updateEntries([...this.entries$.value]),this.stackFileService.markDirty())}}clearOutputs(){for(let t of this.entries$.value)t.clearOutputs();this.executionCounter=0,this.stackFileService.logs$.next([]),this.stackFileService.updateEntries([...this.entries$.value]),this.entries$.value.length&&this.selectEntry(this.entries$.value[0])}async runSelection(){let t=this.selectedEntry$.value;t&&(this.running$.next(!0),this.runEntry(t))}async runEntry(t){let e=++this.executionCounter,{instance:i,processor:a}=this.yamcs;if(t.clearOutputs(),t instanceof pe){let s=t.namespace??null;return this.yamcs.yamcsClient.issueCommandForNamespace(i,a,s,t.name,{sequenceNumber:e,args:t.args,stream:t.stream,extra:t.extra}).then(m=>{t.executionNumber=e,t.executing=!0,t.id=m.id;let h=`Sending command ${t}`;this.stackFileService.addLogEntry(e,h);let x=this.commandHistoryRecords.get(t.id);x&&(t.record=x,this.checkAckContinueRunning(t,x))}).catch(m=>{t.executionNumber=e,t.executing=!1,t.err=m.message||m,this.stopRun()}).finally(()=>{this.stackFileService.updateEntries([...this.entries$.value])})}else if(t instanceof ke)t.executionNumber=e,t.executing=!0,await this.runVerifyEntry(t);else if(t instanceof Ee){let s=[];for(let m of t.parameters){let h=this.pvals$.value;s.push({parameter:m.parameter,pval:h[m.parameter]||null})}t.pvals=s,t.executionNumber=e,this.stackFileService.updateEntries([...this.entries$.value]),this.continueRunning(t)}else t instanceof xe&&(t.executionNumber=e,this.stackFileService.updateEntries([...this.entries$.value]),this.continueRunning(t))}async runVerifyEntry(t){let e=`Verifying ${t}`;this.stackFileService.addLogEntry(t.executionNumber,e);let i=this.pvals$.pipe();if(t.delay&&t.delay>0&&(i=i.pipe(Ni(t.delay))),i=i.pipe(ft(s=>this.testVerifyEntry(t)),Oi()),t.timeout&&t.timeout>0){let s=Math.max(0,t.delay||0);i=i.pipe(Pi(s+t.timeout))}let a=i.subscribe({next:()=>this.continueRunning(t),error:s=>{s instanceof Mi&&(t.executing=!1,t.err=s.message||String(s),this.stopRun())}});this.stepScopedSubscriptions.push(a)}testVerifyEntry(t){let e=t.test(this.pvals$.value);return this.stackFileService.updateEntries([...this.entries$.value]),e}runFromSelection(){let t=this.selectedEntry$.value;if(!t){this.stopRun();return}this.running$.next(!0),this.runningStack=!0,this.nextEntryScheduled=!1,this.runEntry(t)}checkAckContinueRunning(t,e){if(!this.running$.value||this.nextEntryScheduled)return;let{advancement:i}=this.stackFileService,a=t.advancement?.acknowledgment||i.acknowledgment,s=t.advancement?.wait??i.wait;if(t.id===e.id){let m=e.acksByName[a];m&&m.status&&(m.status==="OK"||m.status==="DISABLED"?this.continueRunning(t,s):(m.status==="NOK"||m.status==="CANCELLED")&&(t.executing=!1,this.stopRun()))}}continueRunning(t,e=0){this.nextEntryScheduled=this.runningStack,this.nextCommandDelayTimeout=window.setTimeout(()=>{t.executing=!1,this.running$.value&&(this.advanceSelection(t),this.runningStack?this.runFromSelection():this.stopRun())},Math.max(e,0))}stopRun(){this.clearStepScopedSubscriptions(),this.running$.next(!1),this.runningStack=!1;for(let t of this.stackFileService.entries$.value)if(t.executing=!1,t instanceof ke)for(let e of t.pvals||[])e?.status&&e.status()==="pending"&&e.status.set("cancelled");window.clearTimeout(this.nextCommandDelayTimeout),this.nextEntryScheduled=!1}clearStepScopedSubscriptions(){this.stepScopedSubscriptions.forEach(t=>t.unsubscribe()),this.stepScopedSubscriptions.length=0}advanceSelection(t){let e=this.stackFileService.entries$.value,i=e.indexOf(t);if(i<e.length-1){let a=e[i+1];this.selectEntry(a);let m=this.entryParent.nativeElement.getElementsByClassName("entry")[i+1];this.isVisible(m)||m.scrollIntoView()}else this.selectedEntry$.next(null)}isVisible(t){let e=t.getBoundingClientRect(),i=Math.max(document.documentElement.clientHeight,window.innerHeight);return!(e.bottom<0||e.top-i>=0)}addCheckEntry(){this.dialog.open(mt,{autoFocus:!1,width:"800px",data:{edit:!1}}).afterClosed().subscribe(t=>{if(t){let e=new Ee(z({type:"check"},t)),i=this.selectedEntry$.value;if(i){let a=this.entries$.value,s=a.indexOf(i);a.splice(s+1,0,e),this.stackFileService.updateEntries([...this.entries$.value])}else this.stackFileService.updateEntries([...this.entries$.value,e]);this.selectEntry(e),this.stackFileService.markDirty(),this.updateParameterSubscription()}})}addVerifyEntry(){this.dialog.open(ut,{autoFocus:!1,width:"800px",data:{edit:!1}}).afterClosed().subscribe(t=>{if(t){let e=new ke(z({type:"verify"},t)),i=this.selectedEntry$.value;if(i){let a=this.entries$.value,s=a.indexOf(i);a.splice(s+1,0,e),this.stackFileService.updateEntries([...this.entries$.value])}else this.stackFileService.updateEntries([...this.entries$.value,e]);this.selectEntry(e),this.stackFileService.markDirty(),this.updateParameterSubscription()}})}addCommandEntry(){this.dialog.open(pt,{width:"70%",height:"100%",autoFocus:!1,position:{right:"0"},panelClass:"dialog-full-size",data:{okLabel:"ADD TO STACK"}}).afterClosed().subscribe(e=>{if(e){let i={type:"command",name:e.command.qualifiedName,args:e.args,comment:e.comment,stream:e.stream,extra:e.extra};e.advancement&&(i.advancement=e.advancement);let a=this.configService.getConfig();if(a.preferredNamespace){for(let h of e.command.alias||[])if(h.namespace===a.preferredNamespace){i.name=h.name,i.namespace=h.namespace;break}}let s=new pe(i);s.command=e.command;let m=this.selectedEntry$.value;if(m){let h=this.entries$.value,x=h.indexOf(m);h.splice(x+1,0,s),this.stackFileService.updateEntries([...this.entries$.value])}else this.stackFileService.updateEntries([...this.entries$.value,s]);this.selectEntry(s),this.stackFileService.markDirty()}})}addTextEntry(){this.dialog.open(dt,{autoFocus:!1,width:"800px",data:{edit:!1}}).afterClosed().subscribe(t=>{if(t){let e=new xe({type:"text",text:t}),i=this.selectedEntry$.value;if(i){let a=this.entries$.value,s=a.indexOf(i);a.splice(s+1,0,e),this.stackFileService.updateEntries([...this.entries$.value])}else this.stackFileService.updateEntries([...this.entries$.value,e]);this.selectEntry(e),this.stackFileService.markDirty()}})}editSelectedEntry(){let t=this.selectedEntry$.value;this.editEntry(t)}editEntry(t){return this.selectEntry(t),t instanceof pe?this.dialog.open(pt,{width:"70%",height:"100%",autoFocus:!1,position:{right:"0"},panelClass:"dialog-full-size",data:{okLabel:"UPDATE",entry:t}}).afterClosed().subscribe(e=>{if(e){let i={type:"command",name:e.command.qualifiedName,args:e.args,comment:e.comment,stream:e.stream,extra:e.extra,advancement:e.advancement},a=this.configService.getConfig();if(a.preferredNamespace){for(let x of e.command.alias||[])if(x.namespace===a.preferredNamespace){i.name=x.name,i.namespace=x.namespace;break}}let s=new pe(i);s.command=e.command;let m=this.entries$.value,h=m.indexOf(t);m.splice(h,1,s),this.stackFileService.updateEntries([...this.entries$.value]),this.selectEntry(s),this.stackFileService.markDirty()}}):t instanceof Ee?this.dialog.open(mt,{autoFocus:!1,width:"800px",data:{edit:!0,entry:t}}).afterClosed().subscribe(e=>{if(e){let i=new Ee(z({type:"check"},e)),a=this.entries$.value,s=a.indexOf(t);a.splice(s,1,i),this.stackFileService.updateEntries([...this.entries$.value]),this.selectEntry(i),this.stackFileService.markDirty(),this.updateParameterSubscription()}}):t instanceof xe?this.dialog.open(dt,{autoFocus:!1,width:"800px",data:{edit:!0,entry:t}}).afterClosed().subscribe(e=>{if(e){let i=new xe({type:"text",text:e}),a=this.entries$.value,s=a.indexOf(t);a.splice(s,1,i),this.stackFileService.updateEntries([...this.entries$.value]),this.selectEntry(i),this.stackFileService.markDirty()}}):t instanceof ke&&this.dialog.open(ut,{autoFocus:!1,width:"800px",data:{edit:!0,entry:t}}).afterClosed().subscribe(e=>{if(e){let i=new ke(z({type:"verify"},e)),a=this.entries$.value,s=a.indexOf(t);a.splice(s,1,i),this.stackFileService.updateEntries([...this.entries$.value]),this.selectEntry(i),this.stackFileService.markDirty(),this.updateParameterSubscription()}}),!1}cutSelectedEntry(){let t=this.selectedEntry$.value;this.advanceSelection(t),this.clipboardEntry$.next(t);let e=this.entries$.value,i=e.indexOf(t);e.splice(i,1),this.stackFileService.updateEntries([...this.entries$.value]),this.stackFileService.markDirty()}copySelectedEntry(){let t=this.selectedEntry$.value;this.clipboardEntry$.next(t)}pasteEntry(){let t=this.clipboardEntry$.value;if(t){let e=t.copy(),i=this.selectedEntry$.value;if(i){let a=this.entries$.value,s=a.indexOf(i);a.splice(s+1,0,e),this.stackFileService.updateEntries([...this.entries$.value])}else this.stackFileService.updateEntries([...this.entries$.value,e]);this.selectEntry(e),this.stackFileService.markDirty()}}showSchedule(){let t=this.yamcs.connectionInfo$.value?.instance?.capabilities||[];return t.indexOf("timeline")!==-1&&t.indexOf("activities")!==-1&&this.authService.getUser().hasSystemPrivilege("ControlTimeline")}openScheduleStackDialog(){this.dialog.open(ii,{width:"600px"}).afterClosed().subscribe(t=>{if(t){let e={type:"ACTIVITY",duration:"0s",name:this.filename,start:t.executionTime,tags:t.tags,activityDefinition:{type:"COMMAND_STACK",args:{processor:this.yamcs.processor,bucket:this.bucket,stack:this.filename}}};this.yamcs.yamcsClient.createTimelineItem(this.yamcs.instance,e).then(()=>{this.messageService.showInfo("Stack scheduled")}).catch(i=>this.messageService.showError(i))}})}setExportURLs(){let t=this.entries$.value.map(s=>s.model),e=new Oe(t,{advancement:this.stackFileService.advancement}),i=new Blob([e.toJSON()],{type:"application/json"});this.jsonBlobUrl=this.sanitizer.sanitize(yi.URL,URL.createObjectURL(i));let a=new Blob([e.toXML()],{type:"application/xml"});this.xmlBlobUrl=this.sanitizer.sanitize(yi.URL,URL.createObjectURL(a))}ngOnDestroy(){this.clearStepScopedSubscriptions(),this.parameterSubscription?.cancel(),this.commandSubscription?.cancel()}static{this.\u0275fac=function(e){return new(e||n)(g(De),g(M),g(Ge),g(Ie),g(ge),g(Ne),g(Wi),g(xn),g(de))}}static{this.\u0275cmp=b({type:n,selectors:[["ng-component"]],viewQuery:function(e,i){if(e&1&&te(zo,5),e&2){let a;ie(a=ne())&&(i.entryParent=a.first)}},inputs:{objectName:"objectName"},decls:88,vars:71,consts:[["addEntryMenu","matMenu"],["exportMenu","matMenu"],["entryParent",""],["icon","arrow_back",3,"routerLink","queryParams"],["matTooltip","Save stack","icon","save",3,"clicked","disabled"],["vertical","",2,"height","100%"],["matTooltip","Add a step below","icon","add_circle_outline","dropdown","true",3,"disabled","matMenuTriggerFor"],[1,"ya-menu"],["mat-menu-item","",3,"click"],["matTooltip","Edit the selected step","icon","edit",3,"clicked","disabled"],["matTooltip","Cut the selected step","icon","content_cut",3,"clicked","disabled"],["matTooltip","Copy the selected step","icon","content_copy",3,"clicked","disabled"],["matTooltip","Paste entry from the clipboard","icon","content_paste",3,"clicked","disabled"],["matTooltip","Run the selected step","icon","play_arrow",3,"clicked","disabled"],["matTooltip","Stop current execution","icon","stop",3,"clicked","disabled"],["matTooltip","Clear all outputs","icon","refresh",3,"clicked","disabled"],["matTooltip","Run all from selected step","icon","playlist_play",3,"clicked","disabled"],["matTooltip","Run stack at a later time","icon","schedule",3,"disabled"],["matTooltip","Export stack","icon","open_in_new",3,"clicked","matMenuTriggerFor","disabled"],["mat-menu-item","",3,"href","download"],[2,"vertical-align","middle"],[2,"color","#cc0000"],[1,"main-pane"],[3,"objectName"],["cdkDropList","",1,"tab-content",3,"cdkDropListDropped"],["id","drag-boundary"],["cdkDrag","","cdkDragBoundary","#drag-boundary",1,"entry",3,"display-text","selected"],["matTooltip","Run stack at a later time","icon","schedule",3,"clicked","disabled"],[2,"vertical-align","bottom","margin-right","10px"],["inline","",2,"vertical-align","bottom"],["cdkDrag","","cdkDragBoundary","#drag-boundary",1,"entry",3,"click","dblclick"],[1,"in"],["cdkDragHandle","",1,"seq"],[1,"body"],[3,"entry","pvals"],[3,"entry"],[1,"comment"],[1,"out"],[1,"title"],[1,"icon14"],[1,"text"],[3,"text"],[1,"seq",3,"click"],[3,"command","inline"],[1,"block"],[2,"padding-right","20px"],[3,"value"]],template:function(e,i){if(e&1){let a=w();o(0,"app-instance-page")(1,"app-instance-toolbar"),d(2,"ya-page-icon-button",3),c(3),y(4,"basename"),o(5,"ya-page-button",4),y(6,"async"),_("clicked",function(){return v(a),S(i.stackFileService.saveStack())}),c(7," Save "),r(),d(8,"mat-divider",5),o(9,"ya-page-button",6),y(10,"async"),c(11," Add step "),r(),o(12,"mat-menu",7,0)(14,"a",8),_("click",function(){return v(a),S(i.addTextEntry())}),o(15,"mat-icon"),c(16,"notes"),r(),c(17," Display text "),r(),d(18,"mat-divider"),o(19,"a",8),_("click",function(){return v(a),S(i.addCheckEntry())}),o(20,"mat-icon"),c(21,"toll"),r(),c(22," List parameters "),r(),o(23,"a",8),_("click",function(){return v(a),S(i.addVerifyEntry())}),o(24,"mat-icon"),c(25,"checklist_rtl"),r(),c(26," Verify parameters "),r(),d(27,"mat-divider"),o(28,"a",8),_("click",function(){return v(a),S(i.addCommandEntry())}),o(29,"mat-icon"),c(30,"rss_feed"),r(),c(31," Send command "),r()(),o(32,"ya-page-icon-button",9),y(33,"async"),y(34,"async"),_("clicked",function(){return v(a),S(i.editSelectedEntry())}),r(),o(35,"ya-page-icon-button",10),y(36,"async"),y(37,"async"),_("clicked",function(){return v(a),S(i.cutSelectedEntry())}),r(),o(38,"ya-page-icon-button",11),y(39,"async"),y(40,"async"),_("clicked",function(){return v(a),S(i.copySelectedEntry())}),r(),o(41,"ya-page-icon-button",12),y(42,"async"),y(43,"async"),_("clicked",function(){return v(a),S(i.pasteEntry())}),r(),d(44,"mat-divider",5),o(45,"ya-page-icon-button",13),y(46,"async"),y(47,"async"),_("clicked",function(){return v(a),S(i.runSelection())}),r(),o(48,"ya-page-icon-button",14),y(49,"async"),_("clicked",function(){return v(a),S(i.stopRun())}),r(),o(50,"ya-page-icon-button",15),y(51,"async"),y(52,"async"),_("clicked",function(){return v(a),S(i.clearOutputs())}),r(),o(53,"ya-page-icon-button",16),y(54,"async"),y(55,"async"),_("clicked",function(){return v(a),S(i.runFromSelection())}),r(),d(56,"mat-divider",5),f(57,Jo,2,1,"ya-page-button",17),d(58,"mat-divider",5),o(59,"ya-page-button",18),_("clicked",function(){return v(a),S(i.setExportURLs())}),c(60," Export "),r(),o(61,"mat-menu",7,1)(63,"a",19),y(64,"basename"),o(65,"mat-icon"),c(66,"data_object"),r(),c(67," YCS FILE "),r(),o(68,"a",19),y(69,"basename"),o(70,"mat-icon"),c(71,"code"),r(),o(72,"span",20),c(73," XML FILE "),o(74,"span",21),c(75,"(legacy)"),r()()()()(),o(76,"div",22)(77,"app-stack-file-page-tabs",23),f(78,Zo,1,0,"ya-dots"),y(79,"async"),r(),f(80,er,4,0,"ya-empty-message")(81,tr,7,0,"ya-empty-message"),o(82,"div",24,2),_("cdkDropListDropped",function(m){return v(a),S(i.handleDrop(m))}),o(84,"div",25),I(85,hr,14,10,"div",26,A),y(87,"async"),r()()()()}if(e&2){let a=J(13),s=J(62);l(2),p("routerLink",i.folderLink)("queryParams",ae(69,Ko,i.yamcs.context)),l(),D(" ",k(4,25,i.filename)," \xA0\xA0\xA0 "),l(2),p("disabled",!k(6,27,i.stackFileService.dirty$)),l(4),p("disabled",!i.format||k(10,29,i.running$))("matMenuTriggerFor",a),l(23),p("disabled",!i.format||k(33,31,i.running$)||!k(34,33,i.selectedEntry$)),l(3),p("disabled",!i.format||k(36,35,i.running$)||!k(37,37,i.selectedEntry$)),l(3),p("disabled",!i.format||k(39,39,i.running$)||!k(40,41,i.selectedEntry$)),l(3),p("disabled",!i.format||k(42,43,i.running$)||!k(43,45,i.clipboardEntry$)),l(4),p("disabled",!i.format||k(46,47,i.running$)||!k(47,49,i.selectedEntry$)),l(3),p("disabled",!i.format||!k(49,51,i.running$)),l(2),p("disabled",!i.format||k(51,53,i.running$)||!k(52,55,i.hasState$)),l(3),p("disabled",!i.format||k(54,57,i.running$)||!k(55,59,i.selectedEntry$)),l(4),C(i.showSchedule()?57:-1),l(2),p("matMenuTriggerFor",s)("disabled",!i.format),l(4),p("href",i.jsonBlobUrl,rt)("download",k(64,61,i.filename)+".ycs"),l(5),p("href",i.xmlBlobUrl,rt)("download",k(69,63,i.filename)+".xml"),l(9),p("objectName",i.objectName),l(),C(k(79,65,i.running$)?78:-1),l(2),C(i.loaded&&!i.format?80:-1),l(),C(i.loaded&&i.format&&!i.entries$.value.length?81:-1),l(4),$(k(87,67,i.entries$))}},dependencies:[Yn,he,ve,tt,ni,oi,ri,ci,$e,si,E,re,ye,un,dn,pn,_e,Ft,Et,Ue,wt,we,bn,Bt,Ae,Xe,Ze,et,Gn],styles:["[_nghost-%COMP%]     h1, [_nghost-%COMP%]     h2, [_nghost-%COMP%]     h3, [_nghost-%COMP%]     h4, [_nghost-%COMP%]     h5, [_nghost-%COMP%]     h6{margin-top:0;line-height:1em}.main-pane[_ngcontent-%COMP%]{position:absolute;inset:0;padding:24px}.tab-content[_ngcontent-%COMP%]{position:absolute;inset:60px 0 0;overflow:auto;padding:24px}.ya-data-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{vertical-align:top}div.entry[_ngcontent-%COMP%]{font-size:12px;line-height:17px;color:#000000a7}div.entry[_ngcontent-%COMP%]   div.in[_ngcontent-%COMP%], div.entry[_ngcontent-%COMP%]   div.out[_ngcontent-%COMP%]{display:flex;border-left:8px solid transparent;margin-bottom:10px}div.entry.selected[_ngcontent-%COMP%]   div.in[_ngcontent-%COMP%], div.entry.selected[_ngcontent-%COMP%]   div.out[_ngcontent-%COMP%]{border-color:var(--y-accent)}div.entry[_ngcontent-%COMP%]   .seq[_ngcontent-%COMP%]{width:64px;text-align:right;padding-top:0;padding-right:10px;user-select:none;-webkit-user-select:none;-moz-user-select:none;-khtml-user-select:none;font-family:Roboto Mono,monospace;color:#bdbdbd}div.entry[_ngcontent-%COMP%]   div.in[_ngcontent-%COMP%]   .seq[_ngcontent-%COMP%]{cursor:move}div.entry.selected[_ngcontent-%COMP%]   .seq[_ngcontent-%COMP%]{color:var(--y-accent)}div.entry[_ngcontent-%COMP%]   .body[_ngcontent-%COMP%]{flex-grow:1;padding:5px}div.entry.display-text[_ngcontent-%COMP%]   .body[_ngcontent-%COMP%]{padding:0}div.entry[_ngcontent-%COMP%]   div.in[_ngcontent-%COMP%]   .body[_ngcontent-%COMP%]{background-color:#fafafa;border:1px solid rgb(224,224,224);font-family:Roboto Mono,monospace}div.entry.display-text[_ngcontent-%COMP%]   div.in[_ngcontent-%COMP%]   .body[_ngcontent-%COMP%]{background-color:inherit;border-color:transparent}div.entry[_ngcontent-%COMP%]   div.out[_ngcontent-%COMP%]   .body.err[_ngcontent-%COMP%]{background-color:#fcc;color:var(--y-error-color)}.cdk-drag-placeholder[_ngcontent-%COMP%]{opacity:.6}.comment[_ngcontent-%COMP%]{margin-top:1em;margin-left:5px;border-left:5px solid rgb(224,224,224);padding:1em}.comment[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]{display:flex;align-items:center;font-weight:500}.comment[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]   .display-text[_ngcontent-%COMP%]{margin-left:5px}"],changeDetection:0})}};var vr=["filename"],pi=class n{constructor(t,e,i,a,s){this.dialogRef=t;this.data=s;this.bucket=a.getStackBucket(),this.storageClient=i.createStorageClient(),this.filenameForm=e.group({name:["",[B.required]],format:["ycs",[B.required]]})}save(){let t=this.filenameForm.get("format").value,e=this.filenameForm.get("name").value.trim()+"."+t,i=this.data.path;i.startsWith("/")&&(i=i.substring(1));let a=i?i+"/"+e:e,s=this.data.prefix+a,m=t==="xml"?new Oe([],{}).toXML():new Oe([],{}).toJSON(),h=t==="xml"?"application/xml":"application/json",x=new Blob([m],{type:h});this.storageClient.uploadObject(this.bucket,s,x).then(()=>{this.dialogRef.close(a)})}static{this.\u0275fac=function(e){return new(e||n)(g(q),g(le),g(M),g(ge),g(Z))}}static{this.\u0275cmp=b({type:n,selectors:[["app-create-stack-dialog"]],viewQuery:function(e,i){if(e&1&&te(vr,5),e&2){let a;ie(a=ne())&&(i.filenameInput=a.first)}},decls:21,vars:4,consts:[["filename",""],["mat-dialog-title",""],[1,"ya-form",3,"formGroup"],["type","text","formControlName","name"],["formControlName","format"],["value","ycs"],["value","xml"],["align","end"],["mat-dialog-close",""],["appearance","primary",3,"click","disabled"]],template:function(e,i){if(e&1){let a=w();o(0,"h2",1),c(1,"Create stack"),r(),o(2,"mat-dialog-content")(3,"form",2)(4,"label"),c(5," Name "),d(6,"input",3,0),r(),d(8,"br"),o(9,"label"),c(10," Format "),o(11,"select",4)(12,"option",5),c(13,"YCS"),r(),o(14,"option",6),c(15,"XML (deprecated)"),r()()()()(),o(16,"mat-dialog-actions",7)(17,"ya-button",8),c(18,"CANCEL"),r(),o(19,"ya-button",9),_("click",function(){return v(a),S(i.save())}),c(20,"SAVE"),r()()}if(e&2){let a;l(3),p("formGroup",i.filenameForm),l(),se("invalid",(a=i.filenameForm.get("name"))==null?null:a.invalid),l(15),p("disabled",!i.filenameForm.valid)}},dependencies:[E,Y,an,on,fe,nn,N,L,G,U,H,ee,X,K,T],encapsulation:2})}};var di=class n{constructor(t,e,i,a){this.dialogRef=t;this.data=a;this.storageClient=i.createStorageClient(),this.form=e.group({name:["",B.required]})}save(){let{path:t,bucket:e}=this.data;t.startsWith("/")&&(t=t.substring(1));let i=this.form.value.name,a=t?`${t}/${i}/`:`${i}/`;this.storageClient.uploadObject(e,a,new Blob).then(()=>this.dialogRef.close(!0))}static{this.\u0275fac=function(e){return new(e||n)(g(q),g(le),g(M),g(Z))}}static{this.\u0275cmp=b({type:n,selectors:[["app-create-stack-folder-dialog"]],decls:12,vars:2,consts:[["mat-dialog-title",""],[1,"ya-form",3,"formGroup"],["type","text","formControlName","name","pattern","\\w[\\w\\s\\.\\-\\(\\)\\[\\]]*"],["align","end"],["mat-dialog-close",""],["appearance","primary",3,"click","disabled"]],template:function(e,i){e&1&&(o(0,"h2",0),c(1,"Create folder"),r(),o(2,"mat-dialog-content")(3,"form",1)(4,"label"),c(5," Folder name "),d(6,"input",2),r()()(),o(7,"mat-dialog-actions",3)(8,"ya-button",4),c(9,"CANCEL"),r(),o(10,"ya-button",5),_("click",function(){return i.save()}),c(11,"CREATE"),r()()),e&2&&(l(3),p("formGroup",i.form),l(7),p("disabled",!i.form.valid))},dependencies:[E,Y,fe,N,L,cn,G,U,H,ee,X,K,T],encapsulation:2,changeDetection:0})}};var ui=class n{constructor(t,e,i,a,s){this.dialogRef=t;this.data=s;this.storageClient=i.createStorageClient(),this.bucket=a.getStackBucket();let m=oe.getBasename(oe.getFilename(this.data.name));this.filenameForm=e.group({name:[m,[B.required]]})}async rename(){let t,e=this.data.name.lastIndexOf("/");e!==-1&&(t=this.data.name.substring(0,e+1));let a=await(await this.storageClient.getObject(this.bucket,this.data.name)).blob(),s=oe.getExtension(oe.getFilename(this.data.name))?.toLowerCase(),m=(t||"")+this.filenameForm.get("name").value+(s?"."+s:"");m!==this.data.name&&(await this.storageClient.uploadObject(this.bucket,m,a),await this.storageClient.deleteObject(this.bucket,this.data.name)),this.dialogRef.close(m)}static{this.\u0275fac=function(e){return new(e||n)(g(q),g(le),g(M),g(ge),g(Z))}}static{this.\u0275cmp=b({type:n,selectors:[["app-rename-stack-dialog"]],decls:13,vars:4,consts:[["filename",""],["mat-dialog-title",""],[1,"ya-form",3,"formGroup"],["type","text","formControlName","name"],["align","end"],["mat-dialog-close",""],["appearance","primary",3,"click","disabled"]],template:function(e,i){if(e&1){let a=w();o(0,"h2",1),c(1,"Rename stack"),r(),o(2,"mat-dialog-content")(3,"form",2)(4,"label"),c(5," Name "),d(6,"input",3,0),r()()(),o(8,"mat-dialog-actions",4)(9,"ya-button",5),c(10,"CANCEL"),r(),o(11,"ya-button",6),_("click",function(){return v(a),S(i.rename())}),c(12," RENAME "),r()()}if(e&2){let a;l(3),p("formGroup",i.filenameForm),l(),se("invalid",(a=i.filenameForm.get("name"))==null?null:a.invalid),l(7),p("disabled",!i.filenameForm.valid)}},dependencies:[E,Y,fe,N,L,G,U,H,ee,X,K,T],encapsulation:2})}};var Sr=["droparea"],kr=["uploader"],_i=n=>({c:n});function xr(n,t){if(n&1){let e=w();o(0,"ya-page-button",10),_("clicked",function(){v(e);let a=u();return S(a.createStack())}),c(1," Create stack "),r()}}function br(n,t){if(n&1){let e=w();o(0,"ya-page-button",11),_("clicked",function(){v(e);let a=u();return S(a.openUploadDialog())}),c(1," Upload stack "),o(2,"input",12,1),_("change",function(){v(e);let a=u();return S(a.importStack())}),r()()}}function Er(n,t){if(n&1){let e=w();o(0,"ya-page-button",13),_("clicked",function(){v(e);let a=u();return S(a.createFolder())}),c(1," Create folder "),r()}}function wr(n,t){if(n&1){let e=w();o(0,"ya-page-button",14),_("clicked",function(){v(e);let a=u();return S(a.deleteSelectedStacks())}),c(1," Delete "),r()}if(n&2){let e=u();p("disabled",!e.selection.hasValue())}}function Dr(n,t){if(n&1&&d(0,"ya-breadcrumb",16),n&2){let e=t.$implicit,i=u(3);p("link",e.route)("queryParams",ae(3,_i,i.yamcs.context))("label",e.name)}}function Fr(n,t){if(n&1&&(o(0,"ya-breadcrumb-trail"),d(1,"ya-breadcrumb",15),I(2,Dr,1,5,"ya-breadcrumb",16,A),r()),n&2){let e=u(),i=u();l(),p("queryParams",ae(1,_i,i.yamcs.context)),l(),$(e)}}function Tr(n,t){n&1&&f(0,Fr,4,3,"ya-breadcrumb-trail"),n&2&&C(t.length?0:-1)}function Mr(n,t){if(n&1){let e=w();o(0,"input",34),_("change",function(a){v(e);let s=u(3);return S(a?s.masterToggle():null)}),r()}if(n&2){let e=u(3);p("checked",e.selection.hasValue()&&e.isAllSelected())}}function Pr(n,t){if(n&1&&(o(0,"th",32),f(1,Mr,1,1,"input",33),r()),n&2){let e=u(2);l(),C(e.mayManageStacks()?1:-1)}}function Vr(n,t){if(n&1){let e=w();o(0,"input",36),_("click",function(a){return v(e),S(a.stopPropagation())})("change",function(a){v(e);let s=u().$implicit,m=u(2);return S(a?m.selection.toggle(s):null)}),r()}if(n&2){let e=u().$implicit,i=u(2);p("checked",i.selection.isSelected(e))}}function Nr(n,t){if(n&1&&(o(0,"td",35),f(1,Vr,1,1,"input",33),r()),n&2){let e=u(2);l(),C(e.mayManageStacks()?1:-1)}}function Or(n,t){n&1&&(o(0,"th",37),c(1,"Name"),r())}function Ar(n,t){if(n&1){let e=w();o(0,"mat-icon",39),c(1," folder "),r(),o(2,"a",40),_("click",function(a){return v(e),S(a.stopPropagation())}),c(3),y(4,"filename"),r()}if(n&2){let e=u().$implicit,i=u(2);l(2),p("routerLink","/procedures/stacks/browse/"+e.name)("queryParams",ae(5,_i,i.yamcs.context)),l(),D(" ",k(4,3,e.name)," ")}}function Ir(n,t){if(n&1){let e=w();o(0,"mat-icon",39),c(1," description "),r(),o(2,"a",41),y(3,"filename"),_("click",function(a){return v(e),S(a.stopPropagation())}),c(4),y(5,"filename"),r()}if(n&2){let e=u().$implicit,i=u(2);l(2),p("routerLink","/procedures/stacks/files/"+e.name)("queryParams",ae(8,_i,i.yamcs.context))("title",k(3,4,e.name)),l(2),D(" ",k(5,6,e.name)," ")}}function $r(n,t){if(n&1&&(o(0,"td",38),f(1,Ar,5,7)(2,Ir,6,10),r()),n&2){let e=t.$implicit;l(),C(e.folder?1:2)}}function Rr(n,t){n&1&&(o(0,"th",37),c(1,"Visibility"),r())}function jr(n,t){n&1&&(o(0,"td",38),c(1,"Private"),r())}function Br(n,t){n&1&&(o(0,"th",37),c(1,"Date modified"),r())}function Lr(n,t){if(n&1&&(o(0,"td",38),c(1),y(2,"datetime"),r()),n&2){let e=t.$implicit;l(),D(" ",k(2,1,e.modified)||"-"," ")}}function Yr(n,t){n&1&&d(0,"th",42)}function Gr(n,t){if(n&1){let e=w();o(0,"ya-more")(1,"button",43),_("click",function(){v(e);let a=u().$implicit,s=u(2);return S(s.renameFile(a))}),c(2,"Rename"),r(),o(3,"a",44),c(4,"Download"),r(),d(5,"mat-divider"),o(6,"button",43),_("click",function(){v(e);let a=u().$implicit,s=u(2);return S(s.deleteFile(a))}),c(7,"Delete"),r()()}if(n&2){let e=u().$implicit;l(3),p("href",e.objectUrl,rt)}}function Ur(n,t){if(n&1&&(o(0,"td",38),f(1,Gr,8,1,"ya-more"),r()),n&2){let e=t.$implicit,i=u(2);l(),C(!e.folder&&i.mayManageStacks()?1:-1)}}function qr(n,t){n&1&&d(0,"th",37)}function Hr(n,t){n&1&&d(0,"span")}function Wr(n,t){n&1&&d(0,"span")}function Qr(n,t){if(n&1&&(o(0,"span"),c(1),y(2,"filename"),y(3,"extension"),r()),n&2){let e=u(2).$implicit;l(),D("Unsupported format '",k(3,3,k(2,1,e.name)),"'")}}function zr(n,t){if(n&1&&(o(0,"span"),f(1,Hr,1,0,"span"),y(2,"filename"),y(3,"extension"),y(4,"lowercase"),f(5,Wr,1,0,"span")(6,Qr,4,5,"span"),r()),n&2){let e,i=u().$implicit;l(),C((e=k(4,5,k(3,3,k(2,1,i.name))))==="xml"?1:e==="ycs"?5:6)}}function Kr(n,t){if(n&1&&(o(0,"td",45),f(1,zr,7,7,"span"),r()),n&2){let e=t.$implicit;l(),C(e.folder?-1:1)}}function Xr(n,t){n&1&&d(0,"tr",46)}function Jr(n,t){if(n&1){let e=w();o(0,"tr",47),_("click",function(){let a=v(e).$implicit,s=u(2);return S(s.toggleOne(a))}),r()}if(n&2){let e=t.$implicit,i=u(2);se("selected",i.selection.isSelected(e))}}function Zr(n,t){if(n&1&&(o(0,"table",9),R(1,17),f(2,Pr,2,1,"th",18)(3,Nr,2,1,"td",19),j(),R(4,20),f(5,Or,2,0,"th",21)(6,$r,3,1,"td",22),j(),R(7,23),f(8,Rr,2,0,"th",21)(9,jr,2,0,"td",22),j(),R(10,24),f(11,Br,2,0,"th",21)(12,Lr,3,3,"td",22),j(),R(13,25),f(14,Yr,1,0,"th",26)(15,Ur,2,1,"td",27),j(),R(16,28),f(17,qr,1,0,"th",21)(18,Kr,2,1,"td",29),j(),f(19,Xr,1,0,"tr",30)(20,Jr,1,2,"tr",31),r()),n&2){let e=u();p("dataSource",e.dataSource),l(19),p("cdkHeaderRowDef",e.displayedColumns),l(),p("cdkRowDefColumns",e.displayedColumns)}}function ec(n,t){n&1&&(o(0,"ya-empty-message"),c(1,"Empty directory."),r())}function tc(n,t){if(n&1){let e=w();o(0,"p")(1,"ya-button",49),_("click",function(){v(e);let a=u(4);return S(a.createStack())}),c(2,"Create a stack"),r(),c(3," or "),o(4,"ya-button",50),_("click",function(){v(e);let a=u(4);return S(a.openUploadDialog())}),c(5,"Import a stack"),r()()}}function ic(n,t){if(n&1&&(o(0,"ya-empty-message",48)(1,"p"),c(2," Stacks are used to interactively execute a prepared set of steps. To start, either: "),r(),f(3,tc,6,0,"p"),r()),n&2){let e=u(3);l(3),C(e.mayManageStacks()?3:-1)}}function nc(n,t){if(n&1&&f(0,ec,2,0,"ya-empty-message")(1,ic,4,1,"ya-empty-message",48),n&2){let e=t,i=u(2);C(i.loaded&&e.length?0:-1),l(),C(i.loaded&&!e.length?1:-1)}}function ac(n,t){if(n&1&&(f(0,nc,2,2),y(1,"async")),n&2){let e,i=u();C((e=k(1,1,i.breadcrumb$))?0:-1,e)}}var fi=class n{constructor(t,e,i,a,s,m,h,x){this.dialog=t;this.yamcs=e;this.router=a;this.route=s;this.authService=m;this.messageService=h;this.configService=x;this.breadcrumb$=new V([]);this.dragActive$=new V(!1);this.displayedColumns=["select","name","modified","actions","formatWarning"];this.dataSource=new He([]);this.selection=new St(!0,[]);this.loaded=!1;this.converting=!1;i.setTitle("Command stacks"),this.storageClient=e.createStorageClient(),this.bucket=x.getStackBucket(),this.loadCurrentFolder(),this.routerSubscription=a.events.pipe(ft(Q=>Q instanceof zi)).subscribe(()=>{this.loadCurrentFolder()})}loadCurrentFolder(){let t={delimiter:"/"},e=this.route.snapshot.url;e.length&&(t.prefix=e.map(i=>i.path).join("/")+"/"),this.storageClient.listObjects(this.bucket,t).then(i=>{this.updateBrowsePath(),this.changedir(i),this.loaded=!0})}changedir(t){this.selection.clear();let e=[];for(let i of t.prefixes||[])e.push({folder:!0,name:i});for(let i of t.objects||[])i.name.endsWith("/")||e.push({folder:!1,name:i.name,modified:i.created,objectUrl:this.storageClient.getObjectURL(this.bucket,i.name)});this.dataSource.data=e}isAllSelected(){let t=this.selection.selected.length,e=this.dataSource.filteredData.length;return t===e&&e>0}masterToggle(){this.isAllSelected()?this.selection.clear():this.dataSource.filteredData.forEach(t=>this.selection.select(t))}toggleOne(t){(!this.selection.isSelected(t)||this.selection.selected.length>1)&&this.selection.clear(),this.selection.toggle(t)}createStack(){this.dialog.open(pi,{width:"400px",data:{path:this.getCurrentPath(),prefix:""}}).afterClosed().subscribe(e=>{e&&this.router.navigateByUrl(`/procedures/stacks/files/${e}?c=${this.yamcs.context}`)})}createFolder(){this.dialog.open(di,{width:"400px",data:{bucket:this.bucket,path:this.getCurrentPath()}}).afterClosed().subscribe({next:()=>this.loadCurrentFolder()})}openUploadDialog(){this.uploaderEl.nativeElement.click()}importStack(){let t=this.getCurrentPath();t.startsWith("/")&&(t=t.substring(1));let e=this.uploaderEl.nativeElement.files,i=[];for(let a in e)if(!isNaN(parseInt(a,10))){let s=e[a],x=""+(t?t+"/"+s.name:s.name),Q=this.storageClient.uploadObject(this.bucket,x,s);i.push(Q)}Promise.all(i).then(()=>this.loadCurrentFolder()).catch(a=>this.messageService.showError(a))}getCurrentPath(){let t="";for(let e of this.route.snapshot.url)t+="/"+e.path;return t||"/"}deleteSelectedStacks(){let t=[],e=[];for(let i of this.selection.selected)i.folder?e.push(this.storageClient.listObjects(this.bucket,{prefix:i.name}).then(a=>{let s=a.objects||[];t.push(...s.map(m=>m.name))})):t.push(i.name);Promise.all(e).then(()=>{if(confirm(`You are about to delete ${t.length} files. Are you sure you want to continue?`)){let i=[];for(let a of t)i.push(this.storageClient.deleteObject(this.bucket,a));Promise.all(i).then(()=>{this.loadCurrentFolder()})}})}renameFile(t){this.dialog.open(ui,{data:{name:t.name},width:"400px"}).afterClosed().subscribe(i=>{i&&this.loadCurrentFolder()})}deleteFile(t){confirm(`Are you sure you want to delete ${t.name}?`)&&this.storageClient.deleteObject(this.bucket,t.name).then(()=>{this.loadCurrentFolder()})}dragEnter(t){return this.dragActive$.next(!0),t.preventDefault(),t.stopPropagation(),!1}dragOver(t){return t.preventDefault(),t.stopPropagation(),!1}dragLeave(t){return this.dragActive$.next(!1),t.preventDefault(),t.stopPropagation(),!1}drop(t){let e=t.dataTransfer||{};if(e){let i=this.getCurrentPath().substring(1);i!==""&&(i+="/"),Bn(e).then(a=>{let s=[];for(let m of a){let h=i+m._fullPath,x=this.storageClient.uploadObject(this.bucket,h,m);s.push(x)}Promise.all(s).finally(()=>{this.loadCurrentFolder()})})}return this.dragActive$.next(!1),t.preventDefault(),t.stopPropagation(),!1}mayManageStacks(){let t=this.authService.getUser();return t.hasObjectPrivilege("ManageBucket",this.bucket)||t.hasSystemPrivilege("ManageAnyBucket")}updateBrowsePath(){let t=[],e="";for(let i of this.route.snapshot.url)e+="/"+i.path,t.push({name:i.path,route:"/procedures/stacks/browse"+e});return this.breadcrumb$.next(t),e||"/"}ngOnDestroy(){this.routerSubscription?.unsubscribe()}static{this.\u0275fac=function(e){return new(e||n)(g(De),g(M),g(Ge),g(vt),g(Ki),g(Ie),g(Ne),g(ge))}}static{this.\u0275cmp=b({type:n,selectors:[["ng-component"]],viewQuery:function(e,i){if(e&1&&(te(Sr,7),te(kr,5)),e&2){let a;ie(a=ne())&&(i.dropArea=a.first),ie(a=ne())&&(i.uploaderEl=a.first)}},decls:17,vars:16,consts:[["droparea",""],["uploader",""],["icon","add_circle_outline"],["icon","file_upload"],["icon","create_new_folder"],["icon","delete",3,"disabled"],[1,"droparea",3,"dragenter"],[1,"droparea-overlay",3,"dragover","dragleave","drop"],[1,"panel-content"],["mat-table","",1,"ya-data-table","expand",3,"dataSource"],["icon","add_circle_outline",3,"clicked"],["icon","file_upload",3,"clicked"],["type","file","hidden","","accept",".xml,.ycs","multiple","",3,"change"],["icon","create_new_folder",3,"clicked"],["icon","delete",3,"clicked","disabled"],["link","/procedures/stacks/browse","icon","account_tree",3,"queryParams"],[3,"link","queryParams","label"],["cdkColumnDef","select"],["mat-header-cell","","class","checkbox",4,"cdkHeaderCellDef"],["mat-cell","","class","checkbox",4,"cdkCellDef"],["cdkColumnDef","name"],["mat-header-cell","",4,"cdkHeaderCellDef"],["mat-cell","",4,"cdkCellDef"],["cdkColumnDef","visibility"],["cdkColumnDef","modified"],["matColumnDef","actions"],["mat-header-cell","","class","expand",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["cdkColumnDef","formatWarning"],["mat-cell","","style","text-align: right",4,"cdkCellDef"],["mat-header-row","",4,"cdkHeaderRowDef"],["mat-row","",3,"selected","click",4,"cdkRowDef","cdkRowDefColumns"],["mat-header-cell","",1,"checkbox"],["type","checkbox",3,"checked"],["type","checkbox",3,"change","checked"],["mat-cell","",1,"checkbox"],["type","checkbox",3,"click","change","checked"],["mat-header-cell",""],["mat-cell",""],[1,"icon12",2,"vertical-align","middle","margin-right","7px"],[3,"click","routerLink","queryParams"],[3,"click","routerLink","queryParams","title"],["mat-header-cell","",1,"expand"],["mat-menu-item","",3,"click"],["mat-menu-item","","download","",3,"href"],["mat-cell","",2,"text-align","right"],["mat-header-row",""],["mat-row","",3,"click"],["headerTitle","Stacks"],["appearance","primary",3,"click"],[3,"click"]],template:function(e,i){if(e&1){let a=w();o(0,"app-instance-page")(1,"app-instance-toolbar"),c(2," Stacks \xA0\xA0\xA0 "),f(3,xr,2,0,"ya-page-button",2)(4,br,4,0,"ya-page-button",3)(5,Er,2,0,"ya-page-button",4)(6,wr,2,1,"ya-page-button",5),r(),o(7,"div",6,0),y(9,"async"),_("dragenter",function(m){return v(a),S(i.dragEnter(m))}),o(10,"div",7),y(11,"async"),_("dragover",function(m){return v(a),S(i.dragOver(m))})("dragleave",function(m){return v(a),S(i.dragLeave(m))})("drop",function(m){return v(a),S(i.drop(m))}),r(),o(12,"div",8),f(13,Tr,1,1),y(14,"async"),f(15,Zr,21,3,"table",9)(16,ac,2,3),r()()()}if(e&2){let a;l(3),C(i.mayManageStacks()?3:-1),l(),C(i.mayManageStacks()?4:-1),l(),C(i.mayManageStacks()?5:-1),l(),C(i.mayManageStacks()?6:-1),l(),se("active",k(9,10,i.dragActive$)),l(3),se("hide",!k(11,12,i.dragActive$)),l(3),C((a=k(14,14,i.breadcrumb$))?13:-1,a),l(2),C(i.dataSource&&i.dataSource.data.length?15:16)}},dependencies:[ve,he,E,re,Ui,ye,_n,Tt,Mt,Pt,fn,_e,Ft,Ue,Fe,Nt,Me,Te,Ot,Pe,At,Ve,$t,It,T,Bt,Fn,Ae,Gt,Nn,Ut],styles:[".droparea[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;overflow:auto}.droparea-overlay[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;box-sizing:border-box;background:#1b61b91a;border:1px solid rgba(27,97,185,1);z-index:10}table[_ngcontent-%COMP%]{-webkit-user-select:none;user-select:none}"],changeDetection:0})}};var gi=class n{static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275cmp=b({type:n,selectors:[["app-stacks-page"]],decls:1,vars:0,template:function(e,i){e&1&&d(0,"router-outlet")},dependencies:[ht],encapsulation:2,changeDetection:0})}};var oc=n=>{let t=n,e=n.findIndex(a=>a.path==="-");e!==-1&&(t=n.slice(0,e));let i=t.map(a=>a.path).join("/");return{consumed:t,posParams:{objectName:new Qi(i,{})}}},Ud=[{path:"",canActivate:[Si,vi],canActivateChild:[ki],runGuardsAndResolvers:"always",component:jn,children:[{path:"stacks",pathMatch:"full",redirectTo:"stacks/browse"},{path:"stacks/browse",component:gi,children:[{path:"**",component:fi}]},{path:"stacks/files",children:[{matcher:oc,providers:[st,de],canActivate:[de],canDeactivate:[ta],children:[{path:"",pathMatch:"full",component:mi},{path:"-/log",component:Xt},{path:"-/settings",component:Jt}]}]},{path:"script",pathMatch:"full",component:Qt},{path:"ext",canActivate:[Si,vi],canActivateChild:[ki],runGuardsAndResolvers:"always",children:[{matcher:$n,component:In}]}]}];export{Ud as ROUTES};
